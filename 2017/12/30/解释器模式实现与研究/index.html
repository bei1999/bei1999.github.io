<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>解释器模式实现与研究 | bei1999 的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="定义它定义了对象与对象之间进行某种操作之后会得到什么值。一般主要应用在OOP开发中的编译器的开发中，所以适用面比较窄。 场景模拟android 系统中的 AndroidManifest文件的解析过程 实现AndroidManifest 中定义了application,activity,service 等标签，在程序启动">
<meta name="keywords" content="Java">
<meta property="og:type" content="article">
<meta property="og:title" content="解释器模式实现与研究">
<meta property="og:url" content="http://yoursite.com/2017/12/30/解释器模式实现与研究/index.html">
<meta property="og:site_name" content="bei1999 的博客">
<meta property="og:description" content="定义它定义了对象与对象之间进行某种操作之后会得到什么值。一般主要应用在OOP开发中的编译器的开发中，所以适用面比较窄。 场景模拟android 系统中的 AndroidManifest文件的解析过程 实现AndroidManifest 中定义了application,activity,service 等标签，在程序启动的时候系统会调用服务PackageManagerService(PMS),PMS">
<meta property="og:locale" content="zh-Hans">
<meta property="og:updated_time" content="2017-12-30T13:12:34.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="解释器模式实现与研究">
<meta name="twitter:description" content="定义它定义了对象与对象之间进行某种操作之后会得到什么值。一般主要应用在OOP开发中的编译器的开发中，所以适用面比较窄。 场景模拟android 系统中的 AndroidManifest文件的解析过程 实现AndroidManifest 中定义了application,activity,service 等标签，在程序启动的时候系统会调用服务PackageManagerService(PMS),PMS">
  
    <link rel="alternate" href="/atom.xml" title="bei1999 的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">bei1999 的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-解释器模式实现与研究" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/解释器模式实现与研究/" class="article-date">
  <time datetime="2017-12-30T13:12:02.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Design-Pattern/">Design Pattern</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      解释器模式实现与研究
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>它定义了对象与对象之间进行某种操作之后会得到什么值。一般主要应用在OOP开发中的编译器的开发中，所以适用面比较窄。</p>
<h2 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h2><p>android 系统中的 AndroidManifest文件的解析过程</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>AndroidManifest 中定义了application,activity,service 等标签，在程序启动的时候系统会调用服务PackageManagerService(PMS),PMS 会调用scanPackageLI方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   *  Scan a package and return the newly parsed package.</span></span><br><span class="line"><span class="comment">   *  Returns null in case of errors and the error code is stored in mLastScanError</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Parsing: "</span> + scanFile);</span><br><span class="line">      parseFlags |= mDefParseFlags;</span><br><span class="line">      PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">      pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">      pp.setOnlyCoreApps(mOnlyCore);</span><br><span class="line">      pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((scanFlags &amp; SCAN_TRUSTED_OVERLAY) != <span class="number">0</span>) &#123;</span><br><span class="line">          parseFlags |= PackageParser.PARSE_TRUSTED_OVERLAY;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">      PackageSetting updatedPkg;</span><br><span class="line">      <span class="comment">// reader</span></span><br><span class="line">      <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">          <span class="comment">// Look to see if we already know about this package.</span></span><br><span class="line">          String oldName = mSettings.mRenamedPackages.get(pkg.packageName);</span><br><span class="line">          <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span> &amp;&amp; pkg.mOriginalPackages.contains(oldName)) &#123;</span><br><span class="line">              <span class="comment">// This package has been renamed to its original name.  Let's</span></span><br><span class="line">              <span class="comment">// use that.</span></span><br><span class="line">              ps = mSettings.peekPackageLPr(oldName);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// If there was no original package, see one for the real package name.</span></span><br><span class="line">          <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">              ps = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Check to see if this package could be hiding/updating a system</span></span><br><span class="line">          <span class="comment">// package.  Must look for it either under the original or real</span></span><br><span class="line">          <span class="comment">// package name depending on our state.</span></span><br><span class="line">          updatedPkg = mSettings.getDisabledSystemPkgLPr(ps != <span class="keyword">null</span> ? ps.name : pkg.packageName);</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_INSTALL &amp;&amp; updatedPkg != <span class="keyword">null</span>) Slog.d(TAG, <span class="string">"updatedPkg = "</span> + updatedPkg);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">boolean</span> updatedPkgBetter = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// First check if this is a system package that may involve an update</span></span><br><span class="line">      <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span> &amp;&amp; (parseFlags&amp;PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// If new package is not located in "/system/priv-app" (e.g. due to an OTA),</span></span><br><span class="line">          <span class="comment">// it needs to drop FLAG_PRIVILEGED.</span></span><br><span class="line">          <span class="keyword">if</span> (locationIsPrivileged(scanFile)) &#123;</span><br><span class="line">              updatedPkg.pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              updatedPkg.pkgPrivateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(scanFile)) &#123;</span><br><span class="line">              <span class="comment">// The path has changed from what was last scanned...  check the</span></span><br><span class="line">              <span class="comment">// version of the new path against what we have stored to determine</span></span><br><span class="line">              <span class="comment">// what to do.</span></span><br><span class="line">              <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Path changing from "</span> + ps.codePath);</span><br><span class="line">              <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line">                  <span class="comment">// The system package has been updated and the code path does not match</span></span><br><span class="line">                  <span class="comment">// Ignore entry. Skip it.</span></span><br><span class="line">                  <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                          + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line">                  <span class="keyword">if</span> (!updatedPkg.codePath.equals(scanFile)) &#123;</span><br><span class="line">                      Slog.w(PackageManagerService.TAG, <span class="string">"Code path for hidden system pkg : "</span></span><br><span class="line">                              + ps.name + <span class="string">" changing from "</span> + updatedPkg.codePathString</span><br><span class="line">                              + <span class="string">" to "</span> + scanFile);</span><br><span class="line">                      updatedPkg.codePath = scanFile;</span><br><span class="line">                      updatedPkg.codePathString = scanFile.toString();</span><br><span class="line">                      updatedPkg.resourcePath = scanFile;</span><br><span class="line">                      updatedPkg.resourcePathString = scanFile.toString();</span><br><span class="line">                  &#125;</span><br><span class="line">                  updatedPkg.pkg = pkg;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                          <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                                  + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                                  + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// The current app on the system partition is better than</span></span><br><span class="line">                  <span class="comment">// what we have updated to on the data partition; switch</span></span><br><span class="line">                  <span class="comment">// back to the system partition version.</span></span><br><span class="line">                  <span class="comment">// At this point, its safely assumed that package installation for</span></span><br><span class="line">                  <span class="comment">// apps in system partition will go through. If not there won't be a working</span></span><br><span class="line">                  <span class="comment">// version of the app</span></span><br><span class="line">                  <span class="comment">// writer</span></span><br><span class="line">                  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                      <span class="comment">// Just remove the loaded entries from package lists.</span></span><br><span class="line">                      mPackages.remove(ps.name);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" reverting from "</span> + ps.codePathString</span><br><span class="line">                          + <span class="string">": new version "</span> + pkg.mVersionCode</span><br><span class="line">                          + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line"></span><br><span class="line">                  InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                          ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">                  <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                      args.cleanUpResourcesLI();</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                      mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">                  &#125;</span><br><span class="line">                  updatedPkgBetter = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// An updated system app will not have the PARSE_IS_SYSTEM flag set</span></span><br><span class="line">          <span class="comment">// initially</span></span><br><span class="line">          parseFlags |= PackageParser.PARSE_IS_SYSTEM;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// An updated privileged app will not have the PARSE_IS_PRIVILEGED</span></span><br><span class="line">          <span class="comment">// flag set initially</span></span><br><span class="line">          <span class="keyword">if</span> ((updatedPkg.pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">              parseFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Verify certificates against what was last scanned</span></span><br><span class="line">      collectCertificatesLI(pp, ps, pkg, scanFile, parseFlags);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * A new system app appeared, but we already had a non-system one of the</span></span><br><span class="line"><span class="comment">       * same name installed earlier.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">boolean</span> shouldHideSystemApp = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (updatedPkg == <span class="keyword">null</span> &amp;&amp; ps != <span class="keyword">null</span></span><br><span class="line">              &amp;&amp; (parseFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span> &amp;&amp; !isSystemApp(ps)) &#123;</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           * Check to make sure the signatures match first. If they don't,</span></span><br><span class="line"><span class="comment">           * wipe the installed application and its data.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">if</span> (compareSignatures(ps.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                  != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">              logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared on system, but"</span></span><br><span class="line">                      + <span class="string">" signatures don't match existing userdata copy; removing"</span>);</span><br><span class="line">              deletePackageLI(pkg.packageName, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">              ps = <span class="keyword">null</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * If the newly-added system app is an older version than the</span></span><br><span class="line"><span class="comment">               * already installed version, hide it. It will be scanned later</span></span><br><span class="line"><span class="comment">               * and re-added like an update.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line">                  shouldHideSystemApp = <span class="keyword">true</span>;</span><br><span class="line">                  logCriticalInfo(Log.INFO, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" but new version "</span> + pkg.mVersionCode + <span class="string">" better than installed "</span></span><br><span class="line">                          + ps.versionCode + <span class="string">"; hiding system"</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   * The newly found system app is a newer version that the</span></span><br><span class="line"><span class="comment">                   * one previously installed. Simply remove the</span></span><br><span class="line"><span class="comment">                   * already-installed application and replace it with our own</span></span><br><span class="line"><span class="comment">                   * while keeping the application data.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line">                  logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" reverting from "</span> + ps.codePathString + <span class="string">": new version "</span></span><br><span class="line">                          + pkg.mVersionCode + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line">                  InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                          ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">                  <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                      args.cleanUpResourcesLI();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The apk is forward locked (not public) if its code and resources</span></span><br><span class="line">      <span class="comment">// are kept in different files. (except for app in either system or</span></span><br><span class="line">      <span class="comment">// vendor path).</span></span><br><span class="line">      <span class="comment">// TODO grab this value from PackageSettings</span></span><br><span class="line">      <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(ps.resourcePath)) &#123;</span><br><span class="line">              parseFlags |= PackageParser.PARSE_FORWARD_LOCK;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> extend to support forward-locked splits</span></span><br><span class="line">      String resourcePath = <span class="keyword">null</span>;</span><br><span class="line">      String baseResourcePath = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span> &amp;&amp; !updatedPkgBetter) &#123;</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.resourcePathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">              resourcePath = ps.resourcePathString;</span><br><span class="line">              baseResourcePath = ps.resourcePathString;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// Should not happen at all. Just log an error.</span></span><br><span class="line">              Slog.e(TAG, <span class="string">"Resource path not set for pkg : "</span> + pkg.packageName);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resourcePath = pkg.codePath;</span><br><span class="line">          baseResourcePath = pkg.baseCodePath;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set application objects path explicitly.</span></span><br><span class="line">      pkg.applicationInfo.volumeUuid = pkg.volumeUuid;</span><br><span class="line">      pkg.applicationInfo.setCodePath(pkg.codePath);</span><br><span class="line">      pkg.applicationInfo.setBaseCodePath(pkg.baseCodePath);</span><br><span class="line">      pkg.applicationInfo.setSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line">      pkg.applicationInfo.setResourcePath(resourcePath);</span><br><span class="line">      pkg.applicationInfo.setBaseResourcePath(baseResourcePath);</span><br><span class="line">      pkg.applicationInfo.setSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Note that we invoke the following method only if we are about to unpack an application</span></span><br><span class="line">      PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags</span><br><span class="line">              | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * If the system app should be overridden by a previously installed</span></span><br><span class="line"><span class="comment">       * data, hide the system app now and let the /data/app scan pick it up</span></span><br><span class="line"><span class="comment">       * again.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (shouldHideSystemApp) &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * We have to grant systems permissions before we hide, because</span></span><br><span class="line"><span class="comment">               * grantPermissions will assume the package update is trying to</span></span><br><span class="line"><span class="comment">               * expand its permissions.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              grantPermissionsLPw(pkg, <span class="keyword">true</span>, pkg.packageName);</span><br><span class="line">              mSettings.disableSystemPackageLPw(pkg.packageName);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> scannedPkg;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的代码发现，重要的部分是下面这句，涉及到了PackageParser.parsePackage()函数方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">           pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageParser.parsePackage() 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the package at the given location. Automatically detects if the</span></span><br><span class="line"><span class="comment">    * package is a monolithic style (single APK file) or cluster style</span></span><br><span class="line"><span class="comment">    * (directory of APKs).</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * This performs sanity checking on cluster style packages, such as</span></span><br><span class="line"><span class="comment">    * requiring identical package name and version codes, a single base APK,</span></span><br><span class="line"><span class="comment">    * and unique split names.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * Note that this &lt;em&gt;does not&lt;/em&gt; perform signature verification; that</span></span><br><span class="line"><span class="comment">    * must be done separately in &#123;<span class="doctag">@link</span> #collectCertificates(Package, int)&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #parsePackageLite(File, int)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">           <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Package <span class="title">parseClusterPackage</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> PackageLite lite = parseClusterPackageLite(packageDir, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mOnlyCoreApps &amp;&amp; !lite.coreApp) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                   <span class="string">"Not a coreApp: "</span> + packageDir);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// Load the base and all splits into the AssetManager</span></span><br><span class="line">           <span class="comment">// so that resources can be overriden when parsing the manifests.</span></span><br><span class="line">           loadApkIntoAssetManager(assets, lite.baseCodePath, flags);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitCodePaths)) &#123;</span><br><span class="line">               <span class="keyword">for</span> (String path : lite.splitCodePaths) &#123;</span><br><span class="line">                   loadApkIntoAssetManager(assets, path, flags);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> File baseApk = <span class="keyword">new</span> File(lite.baseCodePath);</span><br><span class="line">           <span class="keyword">final</span> Package pkg = parseBaseApk(baseApk, assets, flags);</span><br><span class="line">           <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                       <span class="string">"Failed to parse base APK: "</span> + baseApk);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitNames)) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> num = lite.splitNames.length;</span><br><span class="line">               pkg.splitNames = lite.splitNames;</span><br><span class="line">               pkg.splitCodePaths = lite.splitCodePaths;</span><br><span class="line">               pkg.splitRevisionCodes = lite.splitRevisionCodes;</span><br><span class="line">               pkg.splitFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line">               pkg.splitPrivateFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line"></span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                   parseSplitApk(pkg, i, assets, flags);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           pkg.codePath = packageDir.getAbsolutePath();</span><br><span class="line">           <span class="keyword">return</span> pkg;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           IoUtils.closeQuietly(assets);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the given APK file, treating it as as a single monolithic package.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * Note that this &lt;em&gt;does not&lt;/em&gt; perform signature verification; that</span></span><br><span class="line"><span class="comment">    * must be done separately in &#123;<span class="doctag">@link</span> #collectCertificates(Package, int)&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@deprecated</span> external callers should move to</span></span><br><span class="line"><span class="comment">    *             &#123;<span class="doctag">@link</span> #parsePackage(File, int)&#125;. Eventually this method will</span></span><br><span class="line"><span class="comment">    *             be marked private.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Deprecated</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mOnlyCoreApps) &#123;</span><br><span class="line">           <span class="keyword">final</span> PackageLite lite = parseMonolithicPackageLite(apkFile, flags);</span><br><span class="line">           <span class="keyword">if</span> (!lite.coreApp) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                       <span class="string">"Not a coreApp: "</span> + apkFile);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line">           pkg.codePath = apkFile.getAbsolutePath();</span><br><span class="line">           <span class="keyword">return</span> pkg;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           IoUtils.closeQuietly(assets);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的两个函数不难发现都同时调用了相同的一个方法<br> parseBaseApk(baseApk, assets, flags); parseBaseApk  经过跳转最终调用如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">String tagName = parser.getName();</span><br><span class="line">          <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                      outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                      mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                      XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                      <span class="keyword">continue</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              foundApp = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, attrs, flags, outError)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure></p>
<p>parseBaseApplication 部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse the &#123;<span class="doctag">@code</span> application&#125; XML tree at the current parse location in a</span></span><br><span class="line"><span class="comment"> * &lt;em&gt;base APK&lt;/em&gt; manifest.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * When adding new features, carefully consider if they should also be</span></span><br><span class="line"><span class="comment"> * supported by split APKs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//省略部分代码....</span></span><br><span class="line">    TypedValue v = sa.peekValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_label);</span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (ai.labelRes=v.resourceId) == <span class="number">0</span>) &#123;</span><br><span class="line">        ai.nonLocalizedLabel = v.coerceToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ai.icon = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_icon, <span class="number">0</span>);</span><br><span class="line">    ai.logo = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_logo, <span class="number">0</span>);</span><br><span class="line">    ai.banner = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_banner, <span class="number">0</span>);</span><br><span class="line">    ai.theme = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_theme, <span class="number">0</span>);</span><br><span class="line">    ai.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_description, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_persistent,</span><br><span class="line">                <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_PERSISTENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_requiredForAllUsers,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        owner.mRequiredForAllUsers = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String restrictedAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_restrictedAccountType);</span><br><span class="line">    <span class="keyword">if</span> (restrictedAccountType != <span class="keyword">null</span> &amp;&amp; restrictedAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRestrictedAccountType = restrictedAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String requiredAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_requiredAccountType);</span><br><span class="line">    <span class="keyword">if</span> (requiredAccountType != <span class="keyword">null</span> &amp;&amp; requiredAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRequiredAccountType = requiredAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_debuggable,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_DEBUGGABLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_vmSafeMode,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_VM_SAFE_MODE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, attrs, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, attrs, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;</span><br><span class="line">            Service s = parseService(owner, res, parser, attrs, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</span><br><span class="line">            Provider p = parseProvider(owner, res, parser, attrs, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"activity-alias"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivityAlias(owner, res, parser, attrs, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="comment">// note: application meta-data is stored off to the side, so it can</span></span><br><span class="line">            <span class="comment">// remain null in the primary copy (we like to avoid extra copies because</span></span><br><span class="line">            <span class="comment">// it can be large)</span></span><br><span class="line">            <span class="keyword">if</span> ((owner.mAppMetaData = parseMetaData(res, parser, attrs, owner.mAppMetaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"library"</span>)) &#123;</span><br><span class="line">            sa = res.obtainAttributes(attrs,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary_name);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.contains(owner.libraryNames, lname)) &#123;</span><br><span class="line">                    owner.libraryNames = ArrayUtils.add(owner.libraryNames, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-library"</span>)) &#123;</span><br><span class="line">            sa = res.obtainAttributes(attrs,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_name);</span><br><span class="line">            <span class="keyword">boolean</span> req = sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_required,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (req) &#123;</span><br><span class="line">                    owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    owner.usesOptionalLibraries = ArrayUtils.add(</span><br><span class="line">                            owner.usesOptionalLibraries, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-package"</span>)) &#123;</span><br><span class="line">            <span class="comment">// Dependencies for app installers; we don't currently try to</span></span><br><span class="line">            <span class="comment">// enforce this.</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;application&gt;: "</span> + tagName</span><br><span class="line">                        + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;application&gt;: "</span> + tagName;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifySharedLibrariesForBackwardCompatibility(owner);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDomainURLs(owner)) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从程序看到，parseApplication 对application 节点的属性进行了解析，而且还对自节点继续解析，下面是对service标签的解析过程，activity等也都有对应的解析函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Service <span class="title">parseService</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">         XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">     TypedArray sa = res.obtainAttributes(attrs,</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mParseServiceArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">         mParseServiceArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_name,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_label,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_icon,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_logo,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_banner,</span><br><span class="line">                 mSeparateProcesses,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_process,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_description,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_enabled);</span><br><span class="line">         mParseServiceArgs.tag = <span class="string">"&lt;service&gt;"</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     mParseServiceArgs.sa = sa;</span><br><span class="line">     mParseServiceArgs.flags = flags;</span><br><span class="line">     </span><br><span class="line">     Service s = <span class="keyword">new</span> Service(mParseServiceArgs, <span class="keyword">new</span> ServiceInfo());</span><br><span class="line">     <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">         sa.recycle();</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">boolean</span> setExported = sa.hasValue(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_exported);</span><br><span class="line">     <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">         s.info.exported = sa.getBoolean(</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_exported, <span class="keyword">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     String str = sa.getNonConfigurationString(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_permission, <span class="number">0</span>);</span><br><span class="line">     <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">         s.info.permission = owner.applicationInfo.permission;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         s.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     s.info.flags = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_stopWithTask,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         s.info.flags |= ServiceInfo.FLAG_STOP_WITH_TASK;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_isolatedProcess,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         s.info.flags |= ServiceInfo.FLAG_ISOLATED_PROCESS;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_singleUser,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         s.info.flags |= ServiceInfo.FLAG_SINGLE_USER;</span><br><span class="line">         <span class="keyword">if</span> (s.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">             Slog.w(TAG, <span class="string">"Service exported request ignored due to singleUser: "</span></span><br><span class="line">                     + s.className + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                     + parser.getPositionDescription());</span><br><span class="line">             s.info.exported = <span class="keyword">false</span>;</span><br><span class="line">             setExported = <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     sa.recycle();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ((owner.applicationInfo.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE)</span><br><span class="line">             != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// A heavy-weight application can not have services in its main process</span></span><br><span class="line">         <span class="comment">// We can do direct compare because we intern all strings.</span></span><br><span class="line">         <span class="keyword">if</span> (s.info.processName == owner.packageName) &#123;</span><br><span class="line">             outError[<span class="number">0</span>] = <span class="string">"Heavy-weight applications can not have services in main process"</span>;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">     <span class="keyword">int</span> type;</span><br><span class="line">     <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                    || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">             <span class="keyword">continue</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123;</span><br><span class="line">             ServiceIntentInfo intent = <span class="keyword">new</span> ServiceIntentInfo(s);</span><br><span class="line">             <span class="keyword">if</span> (!parseIntent(res, parser, attrs, <span class="keyword">true</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             s.intents.add(intent);</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">             <span class="keyword">if</span> ((s.metaData=parseMetaData(res, parser, attrs, s.metaData,</span><br><span class="line">                     outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                 Slog.w(TAG, <span class="string">"Unknown element under &lt;service&gt;: "</span></span><br><span class="line">                         + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                         + parser.getPositionDescription());</span><br><span class="line">                 XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;service&gt;: "</span> + parser.getName();</span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!setExported) &#123;</span><br><span class="line">         s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> s;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>android 系统中的PackageManagerService 代码很长，篇幅有限，只是拿对app解析部分进行举例说明解释器模式的具体应用<br>优点：灵活，适合扩展，扩展只需要增加对应的解释器。<br>缺点：很类似java 对xml的解析，DOM,SAX等需要逐条解析，每一条文法至少对应一个解释器，文件类会增多。若构建的抽象语法树复杂的话，会导致维护困难。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/解释器模式实现与研究/" data-id="ckh22rh0v004qbz3k6vj87ro3" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2017/12/30/自定义view－标签/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Nieuwer</strong>
      <div class="article-nav-title">
        
          自定义view－标签
        
      </div>
    </a>
  
  
    <a href="/2017/12/30/跨进程通讯之AIDL总结实现/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">跨进程通讯之AIDL总结实现</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categorieën</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Config/">Config</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CustomView/">CustomView</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/">Design Pattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/media/">media</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activity/">Activity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activity-View/">Activity View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Glide/">Glide</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ImageView/">ImageView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jni/">Jni</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ndk/">Ndk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProGuard/">ProGuard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Retrofit/">Retrofit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ScaleType/">ScaleType</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clock/">clock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/media/">media</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/permission/">permission</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewgroup/">viewgroup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Activity/" style="font-size: 13.33px;">Activity</a> <a href="/tags/Activity-View/" style="font-size: 10px;">Activity View</a> <a href="/tags/Glide/" style="font-size: 10px;">Glide</a> <a href="/tags/ImageView/" style="font-size: 10px;">ImageView</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Jni/" style="font-size: 10px;">Jni</a> <a href="/tags/Ndk/" style="font-size: 10px;">Ndk</a> <a href="/tags/ProGuard/" style="font-size: 10px;">ProGuard</a> <a href="/tags/Retrofit/" style="font-size: 16.67px;">Retrofit</a> <a href="/tags/ScaleType/" style="font-size: 10px;">ScaleType</a> <a href="/tags/clock/" style="font-size: 13.33px;">clock</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jenkins/" style="font-size: 13.33px;">jenkins</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/media/" style="font-size: 13.33px;">media</a> <a href="/tags/permission/" style="font-size: 10px;">permission</a> <a href="/tags/viewgroup/" style="font-size: 10px;">viewgroup</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/03/项目解耦之context获取/">项目解耦之context获取</a>
          </li>
        
          <li>
            <a href="/2020/10/29/Activity如何计算view的层级深度/">Activity如何计算view的层级深度</a>
          </li>
        
          <li>
            <a href="/2020/10/28/搜索项目apk文件/">搜索项目apk文件</a>
          </li>
        
          <li>
            <a href="/2018/01/14/Ijkplayer-android端执行流程分析/">Ijkplayer android端执行流程分析</a>
          </li>
        
          <li>
            <a href="/2018/01/14/android-播放器调研分析/">android 播放器调研分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 bei1999<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>