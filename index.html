<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>bei1999 的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="bei1999 的博客">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="bei1999 的博客">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="bei1999 的博客">
  
    <link rel="alternate" href="/atom.xml" title="bei1999 的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">bei1999 的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-Activity如何计算view的层级深度" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/29/Activity如何计算view的层级深度/" class="article-date">
  <time datetime="2020-10-29T11:28:08.000Z" itemprop="datePublished">2020-10-29</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/29/Activity如何计算view的层级深度/">Activity如何计算view的层级深度</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>通过activity遍历其view布局的层级深度</p>
        
          <p class="article-more-link">
            <a href="/2020/10/29/Activity如何计算view的层级深度/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/10/29/Activity如何计算view的层级深度/" data-id="ckgur4yi100014z3koajl2lq6" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Activity-View/">Activity View</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-搜索项目apk文件" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2020/10/28/搜索项目apk文件/" class="article-date">
  <time datetime="2020-10-28T14:05:02.000Z" itemprop="datePublished">2020-10-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2020/10/28/搜索项目apk文件/">搜索项目apk文件</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>利用广度优先搜索实现对Android 工程下apk文件进行搜索<br>
        
          <p class="article-more-link">
            <a href="/2020/10/28/搜索项目apk文件/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2020/10/28/搜索项目apk文件/" data-id="ckgur4yky00364z3kvfy3c05h" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-Ijkplayer-android端执行流程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/14/Ijkplayer-android端执行流程分析/" class="article-date">
  <time datetime="2018-01-14T13:16:34.000Z" itemprop="datePublished">2018-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/media/">media</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/14/Ijkplayer-android端执行流程分析/">Ijkplayer android端执行流程分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近项目涉及到直播流播放器，于是对b站开源的ijkplayer进行了编译，过程之中并阅读了下这个开发源码，做个笔记吧。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>按照github 上的介绍逐步执行脚本就ok了，导入as最后的结构如下：</p>
<p><img src="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202018-01-12%20下午5.30.22.png" width="400"></p>
<h2 id="工程分析"><a href="#工程分析" class="headerlink" title="工程分析"></a>工程分析</h2>
        
          <p class="article-more-link">
            <a href="/2018/01/14/Ijkplayer-android端执行流程分析/#more">Read More</a>
          </p>
        
      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/14/Ijkplayer-android端执行流程分析/" data-id="ckgur4yjd000v4z3kpuctr49i" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/media/">media</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-android-播放器调研分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/14/android-播放器调研分析/" class="article-date">
  <time datetime="2018-01-14T13:11:14.000Z" itemprop="datePublished">2018-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/media/">media</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/14/android-播放器调研分析/">android 播放器调研分析</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>项目中涉及到直播流，项目开发之初用了一款老外付费提供的播放器jwplayer，在实际的使用过程中发现了一些问题，这真是一段不堪回首的往事🙈，当然我下面会说明这点。</p>
<h2 id="关于jwplayer"><a href="#关于jwplayer" class="headerlink" title="关于jwplayer"></a>关于jwplayer</h2><p>既然我花钱了，为什么还是存在一些问题呢？？？<br>首先，jwplayer 主推网页端播放器，客户端其实就是对网页播放器的一层包装，常规的一些播放等的操作其实洗洗琢磨还是可以使用的，然而我们有非常强大的产品同学希望对播放器的皮肤文字按钮等深度定制，经过各种邮件和分析，有些已经解决，有些成了历史问题。<br>有没有可能我们重新花钱去找一家公司？替我们完成所有的开发工作，并且扫清所有bug呢？</p>
<p>不用着急回答上面的疑问，我们先了解下一些基础知识</p>
<h2 id="CPU-架构"><a href="#CPU-架构" class="headerlink" title="CPU 架构"></a>CPU 架构</h2><p>CPU架构是CPU厂商给属于同一系列的CPU产品定的一个规范，主要目的是为了区分不同类型CPU的重要标示。目前市面上的CPU分类主要分有两大阵营，一个是intel、AMD为首的复杂指令集CPU，另一个是以IBM、ARM为首的精简指令集CPU。两个不同品牌的CPU，其产品的架构也不相同，例如，Intel、AMD的CPU是X86架构的，而IBM公司的CPU是PowerPC架构，ARM公司是ARM架构。</p>
<p>上面说了pc端的cpu架构情况，Android 系统目前支持 ARMv5、ARMv7、ARMv8、 x86 、x86_64、MIPS 以及 MIPS64 共七种 CPU 架构，也就是说除此之外其他 CPU 架构的硬件并不能运行 Android 系统。</p>
<h2 id="交叉编译"><a href="#交叉编译" class="headerlink" title="交叉编译"></a>交叉编译</h2><p>在某个平台上，编译另一种平台的可执行程序，就是交叉编译，比如在 x86 平台上，编译 arm 平台的可执行程序，这也是 Android 端使用最多的交叉编译类型。</p>
<p>在交叉编译时，由于主机与目标的体系架构、环境不同，所以交叉编译比本地编译复杂很多，需要一些工具来解决主机与目标不同特性的问题，这些工具构成的工具集就叫做交叉编译链。</p>
<h2 id="NDK"><a href="#NDK" class="headerlink" title="NDK"></a>NDK</h2><p>Android NDK 是在SDK前面又加上了“原生”二字，即Native Development Kit，因此又被Google称为“NDK”</p>
<h2 id="JNI"><a href="#JNI" class="headerlink" title="JNI"></a>JNI</h2><p>JNI是Java Native Interface的缩写，它提供了若干的API实现了Java和其他语言的通信（主要是C&amp;C++）</p>
<h2 id="FFmpeg-简介"><a href="#FFmpeg-简介" class="headerlink" title="FFmpeg 简介"></a>FFmpeg 简介</h2><p> FFmpeg是一套可以用来记录、转换数字音频、视频，并能将其转化为流的开源计算机程序。它包括了领先的音/视频编码库libavcodec等。</p>
<ul>
<li>libavformat：用于各种音视频封装格式的生成和解析，包括获取解码所需信息以生成解码上下文结构和读取音视频帧等功能；</li>
<li>libavcodec：用于各种类型声音/图像编解码；</li>
<li>libavutil：包含一些公共的工具函数；</li>
<li>libswscale：用于视频场景比例缩放、色彩映射转换；</li>
<li>libpostproc：用于后期效果处理；</li>
<li>ffmpeg：该项目提供的一个工具，可用于格式转换、解码或电视卡即时编码等；</li>
<li>ffsever：一个 HTTP 多媒体即时广播串流服务器；</li>
<li>ffplay：是一个简单的播放器，使用ffmpeg 库解析和解码，通过SDL显示；</li>
</ul>
<p>ffmpeg是一个国外著名的开源项目，当然站在巨人的肩膀上，你就会飞！😄由于FFmpeg是在LGPL/GPL协议下发布的（如果使用了其中一些使用GPL协议发布的模块则必须使用GPL协议），任何人都可以自由使用，但必须严格遵守LGPL/GPL协议。有很多播放软件都使用了FFmpeg的代码，但它们并没有遵守LGPL/GPL协议，没有公开任何源代码。于是被官方加入了耻辱黑名单，比如暴风影音、QQ影音等。</p>
<h2 id="android-平台编译ffmpeg"><a href="#android-平台编译ffmpeg" class="headerlink" title="android 平台编译ffmpeg"></a>android 平台编译ffmpeg</h2><p>上面提到的了android 手机多种cpu架构，ffmpeg是一个处理视频的复杂操作开源项目。那么基于ffmpeg编解码，从0到1做个播放器有需要做哪些工作？</p>
<ol>
<li>编译 FFmpeg</li>
<li>新建jni编写对应的C/C++调用FFmpeg编译生成的so库</li>
<li>ndk build 将该 C/C++ 文件编译成动态链接库，根据需求生成指定cpu架构so库</li>
<li>android 工程加载so动态库</li>
<li>播放器的框架编写</li>
<li>播放器的ui控制编写</li>
<li>产品需求的开发修改</li>
</ol>
<p>简单的说这个叫ffmpeg 的东西能处理视频的编解码，视频的一些处理工作，但我们需要的是一个播放器，播放器，而不是一个什么c，c＋＋的开发工具！如果我们花费大量的时间去从底层开始封装到使用，这样产品童鞋已疯！于是开始调研市面上的成品与半成品播放器。</p>
<h2 id="调研"><a href="#调研" class="headerlink" title="调研"></a>调研</h2><ol>
<li>Vitamio</li>
</ol>
<p>Vitamio是Android平台视音频播放组件，支持播放几乎格式的视频以及主流网络视频流（http/rtsp/mms等）<br>注：Vitamio 源自美拍一个做播放器的team，目前开发team解散了，无法联系合作。</p>
<ol>
<li>VLC </li>
</ol>
<p>VLC 底层基于ffmpeg ios平台支持比较好，android 平台支持比较简陋，给出了android 一个集成的例子</p>
<ol>
<li>ijkplayer</li>
</ol>
<p>ijkplayer是b站开源的超级好用的视频播放器喔。ijkplayer Android和ios都可用，还支持多种视频的硬解码。底层编解码基于FFmpeg 的ffplay实现，国内各大直播平台很多基于它进行定制开发。</p>
<ol>
<li>JiaoZiVideoPlayer</li>
</ol>
<p>JiaoZiVideoPlayer 属于个人开发者项目，中文名节操视频播放器，基于android videoview实现的视频播放框架，可切换播放器引擎Ijkplayer Exoplayer Vitamio等。联系不到作者有版权问题。</p>
<ol>
<li>GSYVideoPlayer</li>
</ol>
<p>基于IJKPlayer，实现了多功能的视频播放器,开源项目有参考JiaoZiVideoPlayer部分代码，但后来做的扩展功能更丰富和强大</p>
<ol>
<li>阿里云播放器</li>
</ol>
<p>联系客服，只做云服务，他们得播放器主要是以短视频录制，发布和直播使用</p>
<ol>
<li>网易云播放器</li>
</ol>
<p>主要做云服务，卖的是浏览，播放器只是一个简易版本</p>
<ol>
<li>爱奇艺播放器</li>
</ol>
<p>主要做云服务，卖的是浏览，播放器只是一个简易版本</p>
<ol>
<li>七牛播放器</li>
</ol>
<p>封装的IJKPlayer 也是一个简易版本 需要二次开发，成本较高</p>
<ol>
<li>腾讯云播放器</li>
</ol>
<p>主要做云服务，卖的是浏览，播放器只是一个简易版本</p>
<ol>
<li>美拍项目播放器</li>
</ol>
<p>自己做了播放器相关集成，这块代码属于商业机密，无法合作。</p>
<ol>
<li>熊猫直播项目播放器</li>
</ol>
<p>封装的IJKPlayer，cto答复没有这方面的合作业务。</p>
<ol>
<li>外包合作team</li>
</ol>
<p>由于项目本身评估并不大，并且需要真正做过直播相关的项目团队，</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>市面上做直播的平台如斗鱼，熊猫直播，美拍直播等都是内部team基于ijkplayer 继续的二次封装开发，比较大型的百度t5播放器，七牛云播放器等出于商业化考虑需要配合云服务使用，不能符合我们的需求。综上所述，目前的方案暂定尝试GSYVideoPlayer与VLC播放器通过进行开发，项目部分集成进行一个灰度测试比较使用的情况，时间充裕还是要基于IJKPlayer进行自己的播放器开发与维护。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://baike.baidu.com/item/%E5%A4%84%E7%90%86%E5%99%A8%E6%9E%B6%E6%9E%84/8535061?fr=aladdin" target="_blank" rel="noopener">CPU架构</a></p>
<p><a href="http://ffmpeg.org/" target="_blank" rel="noopener">FFmpeg官网</a></p>
<p><a href="http://vitamio.org" target="_blank" rel="noopener">Vitamio官网</a></p>
<p><a href="https://code.videolan.org/videolan/vlc-android" target="_blank" rel="noopener">VLC的android 集成项目地址</a></p>
<p><a href="https://github.com/Bilibili/ijkplayer" target="_blank" rel="noopener">ijkplayer的github地址</a></p>
<p><a href="https://github.com/lipangit/JiaoZiVideoPlayer" target="_blank" rel="noopener">节操视频播放器地址</a></p>
<p><a href="https://github.com/CarGuo/GSYVideoPlayer" target="_blank" rel="noopener">GSYVideoPlayer github地址</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/14/android-播放器调研分析/" data-id="ckgur4ykg002b4z3k83p54wdr" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/media/">media</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-自定义view－标签" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/自定义view－标签/" class="article-date">
  <time datetime="2017-12-30T13:13:31.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/CustomView/">CustomView</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/自定义view－标签/">自定义view－标签</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近在看viewgroup 的自定义view过程，闲来无事，写一个 常见的选择标签控件，发现这个过程遇到一些坑😄</p>
<h2 id="需求分析"><a href="#需求分析" class="headerlink" title="需求分析"></a>需求分析</h2><ol>
<li>需要定义个容器类，linerlayout ，relativelayout,viewgroup.等，由于存在换行问题，还是用viewgroup做</li>
<li>里面的条目是圆角的，并且随着文字长度变化，需要找美工？算了，自己写吧😢</li>
<li>测量的时候宽度整体matchparent 不用考虑了，高度？ 当换行的时候高度增加</li>
<li>排列的时候超过屏幕宽度需要换行？嗯</li>
<li>点击变个颜色？click 点击事件改变背景颜色。</li>
</ol>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.bei.test.widget;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail :</span></span><br><span class="line"><span class="comment"> * time   : 2017/12/28</span></span><br><span class="line"><span class="comment"> * desc   :</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">MyFlowLayout</span> <span class="keyword">extends</span> <span class="title">ViewGroup</span></span>&#123;</span><br><span class="line">    <span class="comment">// 子View的水平间隔</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> <span class="keyword">int</span> padding = <span class="number">20</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyFlowLayout</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context,<span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyFlowLayout</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs,<span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">MyFlowLayout</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        super.onMeasure(widthMeasureSpec,heightMeasureSpec);</span></span><br><span class="line">        Log.d(<span class="string">"bei"</span>,<span class="string">"onMesure--"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得它的父容器为它设置的测量模式和大小</span></span><br><span class="line">        <span class="keyword">int</span> sizeWidth = MeasureSpec.getSize(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> modeWidth = MeasureSpec.getMode(widthMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> sizeHeight = MeasureSpec.getSize(heightMeasureSpec);</span><br><span class="line">        <span class="keyword">int</span> modeHeight = MeasureSpec.getMode(heightMeasureSpec);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 用于warp_content情况下，来记录父view宽和高</span></span><br><span class="line">        <span class="keyword">int</span> width = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> height = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 取每一行宽度的最大值</span></span><br><span class="line">        <span class="keyword">int</span> lineWidth = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 每一行的高度累加</span></span><br><span class="line">        <span class="keyword">int</span> lineHeight = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 获得子view的个数</span></span><br><span class="line">        <span class="keyword">int</span> cCount = getChildCount();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            View child = getChildAt(i);</span><br><span class="line">            <span class="comment">// 测量子View的宽和高（子view在布局文件中是wrap_content）</span></span><br><span class="line">            measureChild(child, widthMeasureSpec, heightMeasureSpec);</span><br><span class="line">            <span class="comment">// 得到LayoutParams</span></span><br><span class="line">            MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 根据测量宽度加上Margin值算出子view的实际宽度（上文中有说明）</span></span><br><span class="line">            <span class="keyword">int</span> childWidth = child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin;</span><br><span class="line">            <span class="comment">// 根据测量高度加上Margin值算出子view的实际高度</span></span><br><span class="line">            <span class="keyword">int</span> childHeight = child.getMeasuredHeight() + lp.topMargin+ lp.bottomMargin;</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 这里的父view是有padding值的，如果再添加一个元素就超出最大宽度就换行</span></span><br><span class="line">            <span class="keyword">if</span> (lineWidth + childWidth &gt; sizeWidth - getPaddingLeft() - getPaddingRight())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 父view宽度=以前父view宽度、当前行宽的最大值</span></span><br><span class="line">                width = Math.max(width, lineWidth);</span><br><span class="line">                <span class="comment">// 换行了，当前行宽=第一个view的宽度</span></span><br><span class="line">                lineWidth = childWidth;</span><br><span class="line">                <span class="comment">// 父view的高度=各行高度之和</span></span><br><span class="line">                height += lineHeight;</span><br><span class="line">                <span class="comment">//换行了，当前行高=第一个view的高度</span></span><br><span class="line">                lineHeight = childHeight;</span><br><span class="line">            &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">// 叠加行宽</span></span><br><span class="line">                lineWidth += childWidth;</span><br><span class="line">                <span class="comment">// 得到当前行最大的高度</span></span><br><span class="line">                lineHeight = Math.max(lineHeight, childHeight);</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">// 最后一个控件</span></span><br><span class="line">            <span class="keyword">if</span> (i == cCount - <span class="number">1</span>)</span><br><span class="line">            &#123;</span><br><span class="line">                width = Math.max(lineWidth, width);</span><br><span class="line">                height += lineHeight;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        setMeasuredDimension(</span><br><span class="line">                modeWidth == MeasureSpec.EXACTLY ? sizeWidth : width + getPaddingLeft() + getPaddingRight(),</span><br><span class="line">                modeHeight == MeasureSpec.EXACTLY ? sizeHeight : height + getPaddingTop()+ getPaddingBottom()</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存储所有的View</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;List&lt;View&gt;&gt; mAllViews = <span class="keyword">new</span> ArrayList&lt;List&lt;View&gt;&gt;();</span><br><span class="line">    <span class="comment">//存储每一行的高度</span></span><br><span class="line">    <span class="keyword">private</span> List&lt;Integer&gt; mLineHeight = <span class="keyword">new</span> ArrayList&lt;Integer&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</span><br><span class="line">        Log.d(<span class="string">"bei"</span>,<span class="string">"onLayout----l,t,r,b"</span>+l+<span class="string">"&amp;"</span>+t+<span class="string">"&amp;"</span>+r+<span class="string">"&amp;"</span>+b);</span><br><span class="line"></span><br><span class="line">        mAllViews.clear();</span><br><span class="line">        mLineHeight.clear();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 当前ViewGroup的宽度</span></span><br><span class="line">        <span class="keyword">int</span> width = getWidth();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> lineWidth = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> lineHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// 存储每一行所有的childView</span></span><br><span class="line">        List&lt;View&gt; lineViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> cCount = getChildCount();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; cCount; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            View child = getChildAt(i);</span><br><span class="line">            MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">int</span> childWidth = child.getMeasuredWidth();</span><br><span class="line">            <span class="keyword">int</span> childHeight = child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 换行，在onMeasure中childWidth是加上Margin值的</span></span><br><span class="line">            <span class="keyword">if</span> (lineWidth + childWidth + lp.leftMargin + lp.rightMargin &gt; width - getPaddingLeft() - getPaddingRight())</span><br><span class="line">            &#123;</span><br><span class="line">                <span class="comment">// 记录行高</span></span><br><span class="line">                mLineHeight.add(lineHeight);</span><br><span class="line">                <span class="comment">// 记录当前行的Views</span></span><br><span class="line">                mAllViews.add(lineViews);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 新行的行宽和行高</span></span><br><span class="line">                lineWidth = <span class="number">0</span>;</span><br><span class="line">                lineHeight = childHeight + lp.topMargin + lp.bottomMargin;</span><br><span class="line">                <span class="comment">// 新行的View集合</span></span><br><span class="line">                lineViews = <span class="keyword">new</span> ArrayList&lt;View&gt;();</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="comment">//不管换不换行都要处理当前子view</span></span><br><span class="line">            lineWidth += childWidth + lp.leftMargin + lp.rightMargin;</span><br><span class="line">            lineHeight = Math.max(lineHeight, childHeight + lp.topMargin+ lp.bottomMargin);</span><br><span class="line">            lineViews.add(child);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 处理最后一行</span></span><br><span class="line">        mLineHeight.add(lineHeight);</span><br><span class="line">        mAllViews.add(lineViews);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 设置子View的位置</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> left = getPaddingLeft();</span><br><span class="line">        <span class="keyword">int</span> top = getPaddingTop();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 行数</span></span><br><span class="line">        <span class="keyword">int</span> lineNum = mAllViews.size();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; lineNum; i++)</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="comment">// 当前行的所有的View</span></span><br><span class="line">            lineViews = mAllViews.get(i);</span><br><span class="line">            lineHeight = mLineHeight.get(i);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; lineViews.size(); j++)</span><br><span class="line">            &#123;</span><br><span class="line">                View child = lineViews.get(j);</span><br><span class="line">                <span class="comment">// 判断child的状态</span></span><br><span class="line">                <span class="keyword">if</span> (child.getVisibility() == View.GONE)</span><br><span class="line">                &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</span><br><span class="line"></span><br><span class="line">                <span class="keyword">int</span> lc = left + lp.leftMargin;</span><br><span class="line">                <span class="keyword">int</span> tc = top + lp.topMargin;</span><br><span class="line">                <span class="keyword">int</span> rc = lc + child.getMeasuredWidth();</span><br><span class="line">                <span class="keyword">int</span> bc = tc + child.getMeasuredHeight();</span><br><span class="line"></span><br><span class="line">                <span class="comment">// 为子View进行布局</span></span><br><span class="line">                child.layout(lc, tc, rc, bc);</span><br><span class="line"></span><br><span class="line">                left += child.getMeasuredWidth() + lp.leftMargin+ lp.rightMargin;</span><br><span class="line">            &#125;</span><br><span class="line">            left = getPaddingLeft() ;</span><br><span class="line">            top += lineHeight ;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarginLayoutParams(getContext(), attrs);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> LayoutParams <span class="title">generateDefaultLayoutParams</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarginLayoutParams(LayoutParams.WRAP_CONTENT, LayoutParams.WRAP_CONTENT);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> LayoutParams <span class="title">generateLayoutParams</span><span class="params">(LayoutParams p)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MarginLayoutParams(p);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>调用的类<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail :</span></span><br><span class="line"><span class="comment"> * time   : 2017/12/28</span></span><br><span class="line"><span class="comment"> * desc   :</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FlowLayoutActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.flowLayout)</span><br><span class="line">    MyFlowLayout flowLayout;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] data = <span class="keyword">new</span> String[]&#123;<span class="string">"football"</span>, <span class="string">"basketball"</span>, <span class="string">"golf"</span>, <span class="string">"polo"</span>, <span class="string">"American football rugby"</span>, <span class="string">"pingpang"</span>&#125;;</span><br><span class="line"></span><br><span class="line">    TextView flowItemTv;</span><br><span class="line"></span><br><span class="line">    LayoutInflater mInflater;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_flow);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        mInflater = LayoutInflater.from(FlowLayoutActivity.<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        initFlowLayout();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initFlowLayout</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; data.length; i++) &#123;</span><br><span class="line">            RelativeLayout itemView = (RelativeLayout) mInflater.inflate(R.layout.flow_item, flowLayout, <span class="keyword">false</span>);</span><br><span class="line">            flowItemTv = (TextView) itemView.findViewById(R.id.flow_item_tv);</span><br><span class="line">            flowItemTv.setText(data[i]);</span><br><span class="line">            flowItemTv.setTag(i);</span><br><span class="line">            flowLayout.addView(itemView);</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对应布局文件<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version="1.0" encoding="utf-8"?&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:layout_height</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">              <span class="attr">android:orientation</span>=<span class="string">"vertical"</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.bei.test.widget.MyFlowLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:padding</span>=<span class="string">"20dp"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">"@+id/flowLayout"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">"match_parent"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">"wrap_content"</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">"#ff0000"</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行截屏</p>
<p><img src="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202017-12-29%20下午5.33.33.png" width="“400”/"></p>
<h2 id="遇到的问题"><a href="#遇到的问题" class="headerlink" title="遇到的问题"></a>遇到的问题</h2><ol>
<li>onMeasure方法中如果不实现 measureChild()方法屏幕不会显示任何东西</li>
<li>onMeasure 测量模式EXACTLY对应match_parent 或具体值 而AT_MOST对应wrap_content</li>
<li><p>MarginLayoutParams的获得需要重写generateLayoutParams（）方法，传入具体的MarginLayoutParams，否则向下转型不安全运行报转型异常</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: android.view.ViewGroup$LayoutParams cannot be cast to android.view.ViewGroup$MarginLayoutParams</span><br></pre></td></tr></table></figure>
</li>
<li><p>换行的处理需要一行一行处理，如果统一处理会发现距离左边距并不是无限变大，换行又要从头开始。</p>
</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>上面简单的实现了一个viewgroup 的控件，后面有时间再完善下</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/自定义view－标签/" data-id="ckgur4yll004g4z3kktpz4ms3" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/viewgroup/">viewgroup</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-解释器模式实现与研究" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/解释器模式实现与研究/" class="article-date">
  <time datetime="2017-12-30T13:12:02.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Design-Pattern/">Design Pattern</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/解释器模式实现与研究/">解释器模式实现与研究</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>它定义了对象与对象之间进行某种操作之后会得到什么值。一般主要应用在OOP开发中的编译器的开发中，所以适用面比较窄。</p>
<h2 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h2><p>android 系统中的 AndroidManifest文件的解析过程</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>AndroidManifest 中定义了application,activity,service 等标签，在程序启动的时候系统会调用服务PackageManagerService(PMS),PMS 会调用scanPackageLI方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   *  Scan a package and return the newly parsed package.</span></span><br><span class="line"><span class="comment">   *  Returns null in case of errors and the error code is stored in mLastScanError</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="keyword">private</span> PackageParser.<span class="function">Package <span class="title">scanPackageLI</span><span class="params">(File scanFile, <span class="keyword">int</span> parseFlags, <span class="keyword">int</span> scanFlags,</span></span></span><br><span class="line"><span class="function"><span class="params">          <span class="keyword">long</span> currentTime, UserHandle user)</span> <span class="keyword">throws</span> PackageManagerException </span>&#123;</span><br><span class="line">      <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Parsing: "</span> + scanFile);</span><br><span class="line">      parseFlags |= mDefParseFlags;</span><br><span class="line">      PackageParser pp = <span class="keyword">new</span> PackageParser();</span><br><span class="line">      pp.setSeparateProcesses(mSeparateProcesses);</span><br><span class="line">      pp.setOnlyCoreApps(mOnlyCore);</span><br><span class="line">      pp.setDisplayMetrics(mMetrics);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((scanFlags &amp; SCAN_TRUSTED_OVERLAY) != <span class="number">0</span>) &#123;</span><br><span class="line">          parseFlags |= PackageParser.PARSE_TRUSTED_OVERLAY;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">final</span> PackageParser.Package pkg;</span><br><span class="line">      <span class="keyword">try</span> &#123;</span><br><span class="line">          pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">      &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">          <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      PackageSetting ps = <span class="keyword">null</span>;</span><br><span class="line">      PackageSetting updatedPkg;</span><br><span class="line">      <span class="comment">// reader</span></span><br><span class="line">      <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">          <span class="comment">// Look to see if we already know about this package.</span></span><br><span class="line">          String oldName = mSettings.mRenamedPackages.get(pkg.packageName);</span><br><span class="line">          <span class="keyword">if</span> (pkg.mOriginalPackages != <span class="keyword">null</span> &amp;&amp; pkg.mOriginalPackages.contains(oldName)) &#123;</span><br><span class="line">              <span class="comment">// This package has been renamed to its original name.  Let's</span></span><br><span class="line">              <span class="comment">// use that.</span></span><br><span class="line">              ps = mSettings.peekPackageLPr(oldName);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// If there was no original package, see one for the real package name.</span></span><br><span class="line">          <span class="keyword">if</span> (ps == <span class="keyword">null</span>) &#123;</span><br><span class="line">              ps = mSettings.peekPackageLPr(pkg.packageName);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Check to see if this package could be hiding/updating a system</span></span><br><span class="line">          <span class="comment">// package.  Must look for it either under the original or real</span></span><br><span class="line">          <span class="comment">// package name depending on our state.</span></span><br><span class="line">          updatedPkg = mSettings.getDisabledSystemPkgLPr(ps != <span class="keyword">null</span> ? ps.name : pkg.packageName);</span><br><span class="line">          <span class="keyword">if</span> (DEBUG_INSTALL &amp;&amp; updatedPkg != <span class="keyword">null</span>) Slog.d(TAG, <span class="string">"updatedPkg = "</span> + updatedPkg);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">boolean</span> updatedPkgBetter = <span class="keyword">false</span>;</span><br><span class="line">      <span class="comment">// First check if this is a system package that may involve an update</span></span><br><span class="line">      <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span> &amp;&amp; (parseFlags&amp;PackageParser.PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="comment">// If new package is not located in "/system/priv-app" (e.g. due to an OTA),</span></span><br><span class="line">          <span class="comment">// it needs to drop FLAG_PRIVILEGED.</span></span><br><span class="line">          <span class="keyword">if</span> (locationIsPrivileged(scanFile)) &#123;</span><br><span class="line">              updatedPkg.pkgPrivateFlags |= ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              updatedPkg.pkgPrivateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_PRIVILEGED;</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(scanFile)) &#123;</span><br><span class="line">              <span class="comment">// The path has changed from what was last scanned...  check the</span></span><br><span class="line">              <span class="comment">// version of the new path against what we have stored to determine</span></span><br><span class="line">              <span class="comment">// what to do.</span></span><br><span class="line">              <span class="keyword">if</span> (DEBUG_INSTALL) Slog.d(TAG, <span class="string">"Path changing from "</span> + ps.codePath);</span><br><span class="line">              <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line">                  <span class="comment">// The system package has been updated and the code path does not match</span></span><br><span class="line">                  <span class="comment">// Ignore entry. Skip it.</span></span><br><span class="line">                  <span class="keyword">if</span> (DEBUG_INSTALL) Slog.i(TAG, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                          + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line">                  <span class="keyword">if</span> (!updatedPkg.codePath.equals(scanFile)) &#123;</span><br><span class="line">                      Slog.w(PackageManagerService.TAG, <span class="string">"Code path for hidden system pkg : "</span></span><br><span class="line">                              + ps.name + <span class="string">" changing from "</span> + updatedPkg.codePathString</span><br><span class="line">                              + <span class="string">" to "</span> + scanFile);</span><br><span class="line">                      updatedPkg.codePath = scanFile;</span><br><span class="line">                      updatedPkg.codePathString = scanFile.toString();</span><br><span class="line">                      updatedPkg.resourcePath = scanFile;</span><br><span class="line">                      updatedPkg.resourcePathString = scanFile.toString();</span><br><span class="line">                  &#125;</span><br><span class="line">                  updatedPkg.pkg = pkg;</span><br><span class="line">                  <span class="keyword">throw</span> <span class="keyword">new</span> PackageManagerException(INSTALL_FAILED_DUPLICATE_PACKAGE,</span><br><span class="line">                          <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                                  + <span class="string">" ignored: updated version "</span> + ps.versionCode</span><br><span class="line">                                  + <span class="string">" better than this "</span> + pkg.mVersionCode);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">// The current app on the system partition is better than</span></span><br><span class="line">                  <span class="comment">// what we have updated to on the data partition; switch</span></span><br><span class="line">                  <span class="comment">// back to the system partition version.</span></span><br><span class="line">                  <span class="comment">// At this point, its safely assumed that package installation for</span></span><br><span class="line">                  <span class="comment">// apps in system partition will go through. If not there won't be a working</span></span><br><span class="line">                  <span class="comment">// version of the app</span></span><br><span class="line">                  <span class="comment">// writer</span></span><br><span class="line">                  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                      <span class="comment">// Just remove the loaded entries from package lists.</span></span><br><span class="line">                      mPackages.remove(ps.name);</span><br><span class="line">                  &#125;</span><br><span class="line"></span><br><span class="line">                  logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" reverting from "</span> + ps.codePathString</span><br><span class="line">                          + <span class="string">": new version "</span> + pkg.mVersionCode</span><br><span class="line">                          + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line"></span><br><span class="line">                  InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                          ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">                  <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                      args.cleanUpResourcesLI();</span><br><span class="line">                  &#125;</span><br><span class="line">                  <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">                      mSettings.enableSystemPackageLPw(ps.name);</span><br><span class="line">                  &#125;</span><br><span class="line">                  updatedPkgBetter = <span class="keyword">true</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> (updatedPkg != <span class="keyword">null</span>) &#123;</span><br><span class="line">          <span class="comment">// An updated system app will not have the PARSE_IS_SYSTEM flag set</span></span><br><span class="line">          <span class="comment">// initially</span></span><br><span class="line">          parseFlags |= PackageParser.PARSE_IS_SYSTEM;</span><br><span class="line"></span><br><span class="line">          <span class="comment">// An updated privileged app will not have the PARSE_IS_PRIVILEGED</span></span><br><span class="line">          <span class="comment">// flag set initially</span></span><br><span class="line">          <span class="keyword">if</span> ((updatedPkg.pkgPrivateFlags &amp; ApplicationInfo.PRIVATE_FLAG_PRIVILEGED) != <span class="number">0</span>) &#123;</span><br><span class="line">              parseFlags |= PackageParser.PARSE_IS_PRIVILEGED;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Verify certificates against what was last scanned</span></span><br><span class="line">      collectCertificatesLI(pp, ps, pkg, scanFile, parseFlags);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * A new system app appeared, but we already had a non-system one of the</span></span><br><span class="line"><span class="comment">       * same name installed earlier.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">boolean</span> shouldHideSystemApp = <span class="keyword">false</span>;</span><br><span class="line">      <span class="keyword">if</span> (updatedPkg == <span class="keyword">null</span> &amp;&amp; ps != <span class="keyword">null</span></span><br><span class="line">              &amp;&amp; (parseFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) != <span class="number">0</span> &amp;&amp; !isSystemApp(ps)) &#123;</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           * Check to make sure the signatures match first. If they don't,</span></span><br><span class="line"><span class="comment">           * wipe the installed application and its data.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">if</span> (compareSignatures(ps.signatures.mSignatures, pkg.mSignatures)</span><br><span class="line">                  != PackageManager.SIGNATURE_MATCH) &#123;</span><br><span class="line">              logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared on system, but"</span></span><br><span class="line">                      + <span class="string">" signatures don't match existing userdata copy; removing"</span>);</span><br><span class="line">              deletePackageLI(pkg.packageName, <span class="keyword">null</span>, <span class="keyword">true</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="number">0</span>, <span class="keyword">null</span>, <span class="keyword">false</span>);</span><br><span class="line">              ps = <span class="keyword">null</span>;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * If the newly-added system app is an older version than the</span></span><br><span class="line"><span class="comment">               * already installed version, hide it. It will be scanned later</span></span><br><span class="line"><span class="comment">               * and re-added like an update.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              <span class="keyword">if</span> (pkg.mVersionCode &lt;= ps.versionCode) &#123;</span><br><span class="line">                  shouldHideSystemApp = <span class="keyword">true</span>;</span><br><span class="line">                  logCriticalInfo(Log.INFO, <span class="string">"Package "</span> + ps.name + <span class="string">" appeared at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" but new version "</span> + pkg.mVersionCode + <span class="string">" better than installed "</span></span><br><span class="line">                          + ps.versionCode + <span class="string">"; hiding system"</span>);</span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  <span class="comment">/*</span></span><br><span class="line"><span class="comment">                   * The newly found system app is a newer version that the</span></span><br><span class="line"><span class="comment">                   * one previously installed. Simply remove the</span></span><br><span class="line"><span class="comment">                   * already-installed application and replace it with our own</span></span><br><span class="line"><span class="comment">                   * while keeping the application data.</span></span><br><span class="line"><span class="comment">                   */</span></span><br><span class="line">                  logCriticalInfo(Log.WARN, <span class="string">"Package "</span> + ps.name + <span class="string">" at "</span> + scanFile</span><br><span class="line">                          + <span class="string">" reverting from "</span> + ps.codePathString + <span class="string">": new version "</span></span><br><span class="line">                          + pkg.mVersionCode + <span class="string">" better than installed "</span> + ps.versionCode);</span><br><span class="line">                  InstallArgs args = createInstallArgsForExisting(packageFlagsToInstallFlags(ps),</span><br><span class="line">                          ps.codePathString, ps.resourcePathString, getAppDexInstructionSets(ps));</span><br><span class="line">                  <span class="keyword">synchronized</span> (mInstallLock) &#123;</span><br><span class="line">                      args.cleanUpResourcesLI();</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// The apk is forward locked (not public) if its code and resources</span></span><br><span class="line">      <span class="comment">// are kept in different files. (except for app in either system or</span></span><br><span class="line">      <span class="comment">// vendor path).</span></span><br><span class="line">      <span class="comment">// TODO grab this value from PackageSettings</span></span><br><span class="line">      <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_IS_SYSTEM_DIR) == <span class="number">0</span>) &#123;</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; !ps.codePath.equals(ps.resourcePath)) &#123;</span><br><span class="line">              parseFlags |= PackageParser.PARSE_FORWARD_LOCK;</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// <span class="doctag">TODO:</span> extend to support forward-locked splits</span></span><br><span class="line">      String resourcePath = <span class="keyword">null</span>;</span><br><span class="line">      String baseResourcePath = <span class="keyword">null</span>;</span><br><span class="line">      <span class="keyword">if</span> ((parseFlags &amp; PackageParser.PARSE_FORWARD_LOCK) != <span class="number">0</span> &amp;&amp; !updatedPkgBetter) &#123;</span><br><span class="line">          <span class="keyword">if</span> (ps != <span class="keyword">null</span> &amp;&amp; ps.resourcePathString != <span class="keyword">null</span>) &#123;</span><br><span class="line">              resourcePath = ps.resourcePathString;</span><br><span class="line">              baseResourcePath = ps.resourcePathString;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// Should not happen at all. Just log an error.</span></span><br><span class="line">              Slog.e(TAG, <span class="string">"Resource path not set for pkg : "</span> + pkg.packageName);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          resourcePath = pkg.codePath;</span><br><span class="line">          baseResourcePath = pkg.baseCodePath;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Set application objects path explicitly.</span></span><br><span class="line">      pkg.applicationInfo.volumeUuid = pkg.volumeUuid;</span><br><span class="line">      pkg.applicationInfo.setCodePath(pkg.codePath);</span><br><span class="line">      pkg.applicationInfo.setBaseCodePath(pkg.baseCodePath);</span><br><span class="line">      pkg.applicationInfo.setSplitCodePaths(pkg.splitCodePaths);</span><br><span class="line">      pkg.applicationInfo.setResourcePath(resourcePath);</span><br><span class="line">      pkg.applicationInfo.setBaseResourcePath(baseResourcePath);</span><br><span class="line">      pkg.applicationInfo.setSplitResourcePaths(pkg.splitCodePaths);</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Note that we invoke the following method only if we are about to unpack an application</span></span><br><span class="line">      PackageParser.Package scannedPkg = scanPackageLI(pkg, parseFlags, scanFlags</span><br><span class="line">              | SCAN_UPDATE_SIGNATURE, currentTime, user);</span><br><span class="line"></span><br><span class="line">      <span class="comment">/*</span></span><br><span class="line"><span class="comment">       * If the system app should be overridden by a previously installed</span></span><br><span class="line"><span class="comment">       * data, hide the system app now and let the /data/app scan pick it up</span></span><br><span class="line"><span class="comment">       * again.</span></span><br><span class="line"><span class="comment">       */</span></span><br><span class="line">      <span class="keyword">if</span> (shouldHideSystemApp) &#123;</span><br><span class="line">          <span class="keyword">synchronized</span> (mPackages) &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * We have to grant systems permissions before we hide, because</span></span><br><span class="line"><span class="comment">               * grantPermissions will assume the package update is trying to</span></span><br><span class="line"><span class="comment">               * expand its permissions.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              grantPermissionsLPw(pkg, <span class="keyword">true</span>, pkg.packageName);</span><br><span class="line">              mSettings.disableSystemPackageLPw(pkg.packageName);</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">return</span> scannedPkg;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过上面的代码发现，重要的部分是下面这句，涉及到了PackageParser.parsePackage()函数方法<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">           pkg = pp.parsePackage(scanFile, parseFlags);</span><br><span class="line">       &#125; <span class="keyword">catch</span> (PackageParserException e) &#123;</span><br><span class="line">           <span class="keyword">throw</span> PackageManagerException.from(e);</span><br><span class="line">       &#125;</span><br></pre></td></tr></table></figure></p>
<p>PackageParser.parsePackage() 如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the package at the given location. Automatically detects if the</span></span><br><span class="line"><span class="comment">    * package is a monolithic style (single APK file) or cluster style</span></span><br><span class="line"><span class="comment">    * (directory of APKs).</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * This performs sanity checking on cluster style packages, such as</span></span><br><span class="line"><span class="comment">    * requiring identical package name and version codes, a single base APK,</span></span><br><span class="line"><span class="comment">    * and unique split names.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * Note that this &lt;em&gt;does not&lt;/em&gt; perform signature verification; that</span></span><br><span class="line"><span class="comment">    * must be done separately in &#123;<span class="doctag">@link</span> #collectCertificates(Package, int)&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@see</span> #parsePackageLite(File, int)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Package <span class="title">parsePackage</span><span class="params">(File packageFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (packageFile.isDirectory()) &#123;</span><br><span class="line">           <span class="keyword">return</span> parseClusterPackage(packageFile, flags);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">return</span> parseMonolithicPackage(packageFile, flags);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> Package <span class="title">parseClusterPackage</span><span class="params">(File packageDir, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> PackageLite lite = parseClusterPackageLite(packageDir, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (mOnlyCoreApps &amp;&amp; !lite.coreApp) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                   <span class="string">"Not a coreApp: "</span> + packageDir);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="comment">// Load the base and all splits into the AssetManager</span></span><br><span class="line">           <span class="comment">// so that resources can be overriden when parsing the manifests.</span></span><br><span class="line">           loadApkIntoAssetManager(assets, lite.baseCodePath, flags);</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitCodePaths)) &#123;</span><br><span class="line">               <span class="keyword">for</span> (String path : lite.splitCodePaths) &#123;</span><br><span class="line">                   loadApkIntoAssetManager(assets, path, flags);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">final</span> File baseApk = <span class="keyword">new</span> File(lite.baseCodePath);</span><br><span class="line">           <span class="keyword">final</span> Package pkg = parseBaseApk(baseApk, assets, flags);</span><br><span class="line">           <span class="keyword">if</span> (pkg == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_NOT_APK,</span><br><span class="line">                       <span class="string">"Failed to parse base APK: "</span> + baseApk);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">if</span> (!ArrayUtils.isEmpty(lite.splitNames)) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> num = lite.splitNames.length;</span><br><span class="line">               pkg.splitNames = lite.splitNames;</span><br><span class="line">               pkg.splitCodePaths = lite.splitCodePaths;</span><br><span class="line">               pkg.splitRevisionCodes = lite.splitRevisionCodes;</span><br><span class="line">               pkg.splitFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line">               pkg.splitPrivateFlags = <span class="keyword">new</span> <span class="keyword">int</span>[num];</span><br><span class="line"></span><br><span class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; num; i++) &#123;</span><br><span class="line">                   parseSplitApk(pkg, i, assets, flags);</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           pkg.codePath = packageDir.getAbsolutePath();</span><br><span class="line">           <span class="keyword">return</span> pkg;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           IoUtils.closeQuietly(assets);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Parse the given APK file, treating it as as a single monolithic package.</span></span><br><span class="line"><span class="comment">    * &lt;p&gt;</span></span><br><span class="line"><span class="comment">    * Note that this &lt;em&gt;does not&lt;/em&gt; perform signature verification; that</span></span><br><span class="line"><span class="comment">    * must be done separately in &#123;<span class="doctag">@link</span> #collectCertificates(Package, int)&#125;.</span></span><br><span class="line"><span class="comment">    *</span></span><br><span class="line"><span class="comment">    * <span class="doctag">@deprecated</span> external callers should move to</span></span><br><span class="line"><span class="comment">    *             &#123;<span class="doctag">@link</span> #parsePackage(File, int)&#125;. Eventually this method will</span></span><br><span class="line"><span class="comment">    *             be marked private.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="meta">@Deprecated</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Package <span class="title">parseMonolithicPackage</span><span class="params">(File apkFile, <span class="keyword">int</span> flags)</span> <span class="keyword">throws</span> PackageParserException </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mOnlyCoreApps) &#123;</span><br><span class="line">           <span class="keyword">final</span> PackageLite lite = parseMonolithicPackageLite(apkFile, flags);</span><br><span class="line">           <span class="keyword">if</span> (!lite.coreApp) &#123;</span><br><span class="line">               <span class="keyword">throw</span> <span class="keyword">new</span> PackageParserException(INSTALL_PARSE_FAILED_MANIFEST_MALFORMED,</span><br><span class="line">                       <span class="string">"Not a coreApp: "</span> + apkFile);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">final</span> AssetManager assets = <span class="keyword">new</span> AssetManager();</span><br><span class="line">       <span class="keyword">try</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> Package pkg = parseBaseApk(apkFile, assets, flags);</span><br><span class="line">           pkg.codePath = apkFile.getAbsolutePath();</span><br><span class="line">           <span class="keyword">return</span> pkg;</span><br><span class="line">       &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">           IoUtils.closeQuietly(assets);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的两个函数不难发现都同时调用了相同的一个方法<br> parseBaseApk(baseApk, assets, flags); parseBaseApk  经过跳转最终调用如下<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">String tagName = parser.getName();</span><br><span class="line">          <span class="keyword">if</span> (tagName.equals(<span class="string">"application"</span>)) &#123;</span><br><span class="line">              <span class="keyword">if</span> (foundApp) &#123;</span><br><span class="line">                  <span class="keyword">if</span> (RIGID_PARSER) &#123;</span><br><span class="line">                      outError[<span class="number">0</span>] = <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>;</span><br><span class="line">                      mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                      <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">                  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                      Slog.w(TAG, <span class="string">"&lt;manifest&gt; has more than one &lt;application&gt;"</span>);</span><br><span class="line">                      XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                      <span class="keyword">continue</span>;</span><br><span class="line">                  &#125;</span><br><span class="line">              &#125;</span><br><span class="line"></span><br><span class="line">              foundApp = <span class="keyword">true</span>;</span><br><span class="line">              <span class="keyword">if</span> (!parseBaseApplication(pkg, res, parser, attrs, flags, outError)) &#123;</span><br><span class="line">                  <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">              &#125;</span><br></pre></td></tr></table></figure></p>
<p>parseBaseApplication 部分代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Parse the &#123;<span class="doctag">@code</span> application&#125; XML tree at the current parse location in a</span></span><br><span class="line"><span class="comment"> * &lt;em&gt;base APK&lt;/em&gt; manifest.</span></span><br><span class="line"><span class="comment"> * &lt;p&gt;</span></span><br><span class="line"><span class="comment"> * When adding new features, carefully consider if they should also be</span></span><br><span class="line"><span class="comment"> * supported by split APKs.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">parseBaseApplication</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">                                     XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">        <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">    </span><br><span class="line"> </span><br><span class="line">    <span class="comment">//省略部分代码....</span></span><br><span class="line">    TypedValue v = sa.peekValue(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_label);</span><br><span class="line">    <span class="keyword">if</span> (v != <span class="keyword">null</span> &amp;&amp; (ai.labelRes=v.resourceId) == <span class="number">0</span>) &#123;</span><br><span class="line">        ai.nonLocalizedLabel = v.coerceToString();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    ai.icon = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_icon, <span class="number">0</span>);</span><br><span class="line">    ai.logo = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_logo, <span class="number">0</span>);</span><br><span class="line">    ai.banner = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_banner, <span class="number">0</span>);</span><br><span class="line">    ai.theme = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_theme, <span class="number">0</span>);</span><br><span class="line">    ai.descriptionRes = sa.getResourceId(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_description, <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> ((flags&amp;PARSE_IS_SYSTEM) != <span class="number">0</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">                com.android.internal.R.styleable.AndroidManifestApplication_persistent,</span><br><span class="line">                <span class="keyword">false</span>)) &#123;</span><br><span class="line">            ai.flags |= ApplicationInfo.FLAG_PERSISTENT;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_requiredForAllUsers,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        owner.mRequiredForAllUsers = <span class="keyword">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String restrictedAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_restrictedAccountType);</span><br><span class="line">    <span class="keyword">if</span> (restrictedAccountType != <span class="keyword">null</span> &amp;&amp; restrictedAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRestrictedAccountType = restrictedAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    String requiredAccountType = sa.getString(com.android.internal.R.styleable</span><br><span class="line">            .AndroidManifestApplication_requiredAccountType);</span><br><span class="line">    <span class="keyword">if</span> (requiredAccountType != <span class="keyword">null</span> &amp;&amp; requiredAccountType.length() &gt; <span class="number">0</span>) &#123;</span><br><span class="line">        owner.mRequiredAccountType = requiredAccountType;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_debuggable,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_DEBUGGABLE;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">            com.android.internal.R.styleable.AndroidManifestApplication_vmSafeMode,</span><br><span class="line">            <span class="keyword">false</span>)) &#123;</span><br><span class="line">        ai.flags |= ApplicationInfo.FLAG_VM_SAFE_MODE;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">final</span> <span class="keyword">int</span> innerDepth = parser.getDepth();</span><br><span class="line">    <span class="keyword">int</span> type;</span><br><span class="line">    <span class="keyword">while</span> ((type = parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG || parser.getDepth() &gt; innerDepth)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">            <span class="keyword">continue</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        String tagName = parser.getName();</span><br><span class="line">        <span class="keyword">if</span> (tagName.equals(<span class="string">"activity"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, attrs, flags, outError, <span class="keyword">false</span>,</span><br><span class="line">                    owner.baseHardwareAccelerated);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"receiver"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivity(owner, res, parser, attrs, flags, outError, <span class="keyword">true</span>, <span class="keyword">false</span>);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.receivers.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"service"</span>)) &#123;</span><br><span class="line">            Service s = parseService(owner, res, parser, attrs, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (s == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.services.add(s);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"provider"</span>)) &#123;</span><br><span class="line">            Provider p = parseProvider(owner, res, parser, attrs, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (p == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.providers.add(p);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"activity-alias"</span>)) &#123;</span><br><span class="line">            Activity a = parseActivityAlias(owner, res, parser, attrs, flags, outError);</span><br><span class="line">            <span class="keyword">if</span> (a == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            owner.activities.add(a);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">            <span class="comment">// note: application meta-data is stored off to the side, so it can</span></span><br><span class="line">            <span class="comment">// remain null in the primary copy (we like to avoid extra copies because</span></span><br><span class="line">            <span class="comment">// it can be large)</span></span><br><span class="line">            <span class="keyword">if</span> ((owner.mAppMetaData = parseMetaData(res, parser, attrs, owner.mAppMetaData,</span><br><span class="line">                    outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"library"</span>)) &#123;</span><br><span class="line">            sa = res.obtainAttributes(attrs,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestLibrary_name);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (!ArrayUtils.contains(owner.libraryNames, lname)) &#123;</span><br><span class="line">                    owner.libraryNames = ArrayUtils.add(owner.libraryNames, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-library"</span>)) &#123;</span><br><span class="line">            sa = res.obtainAttributes(attrs,</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Note: don't allow this value to be a reference to a resource</span></span><br><span class="line">            <span class="comment">// that may change.</span></span><br><span class="line">            String lname = sa.getNonResourceString(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_name);</span><br><span class="line">            <span class="keyword">boolean</span> req = sa.getBoolean(</span><br><span class="line">                    com.android.internal.R.styleable.AndroidManifestUsesLibrary_required,</span><br><span class="line">                    <span class="keyword">true</span>);</span><br><span class="line"></span><br><span class="line">            sa.recycle();</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (lname != <span class="keyword">null</span>) &#123;</span><br><span class="line">                lname = lname.intern();</span><br><span class="line">                <span class="keyword">if</span> (req) &#123;</span><br><span class="line">                    owner.usesLibraries = ArrayUtils.add(owner.usesLibraries, lname);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    owner.usesOptionalLibraries = ArrayUtils.add(</span><br><span class="line">                            owner.usesOptionalLibraries, lname);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (tagName.equals(<span class="string">"uses-package"</span>)) &#123;</span><br><span class="line">            <span class="comment">// Dependencies for app installers; we don't currently try to</span></span><br><span class="line">            <span class="comment">// enforce this.</span></span><br><span class="line">            XmlUtils.skipCurrentTag(parser);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                Slog.w(TAG, <span class="string">"Unknown element under &lt;application&gt;: "</span> + tagName</span><br><span class="line">                        + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                        + parser.getPositionDescription());</span><br><span class="line">                XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                <span class="keyword">continue</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;application&gt;: "</span> + tagName;</span><br><span class="line">                mParseError = PackageManager.INSTALL_PARSE_FAILED_MANIFEST_MALFORMED;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    modifySharedLibrariesForBackwardCompatibility(owner);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (hasDomainURLs(owner)) &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags |= ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        owner.applicationInfo.privateFlags &amp;= ~ApplicationInfo.PRIVATE_FLAG_HAS_DOMAIN_URLS;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从程序看到，parseApplication 对application 节点的属性进行了解析，而且还对自节点继续解析，下面是对service标签的解析过程，activity等也都有对应的解析函数<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> Service <span class="title">parseService</span><span class="params">(Package owner, Resources res,</span></span></span><br><span class="line"><span class="function"><span class="params">         XmlPullParser parser, AttributeSet attrs, <span class="keyword">int</span> flags, String[] outError)</span></span></span><br><span class="line"><span class="function">         <span class="keyword">throws</span> XmlPullParserException, IOException </span>&#123;</span><br><span class="line">     TypedArray sa = res.obtainAttributes(attrs,</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService);</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (mParseServiceArgs == <span class="keyword">null</span>) &#123;</span><br><span class="line">         mParseServiceArgs = <span class="keyword">new</span> ParseComponentArgs(owner, outError,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_name,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_label,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_icon,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_logo,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_banner,</span><br><span class="line">                 mSeparateProcesses,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_process,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_description,</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_enabled);</span><br><span class="line">         mParseServiceArgs.tag = <span class="string">"&lt;service&gt;"</span>;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     mParseServiceArgs.sa = sa;</span><br><span class="line">     mParseServiceArgs.flags = flags;</span><br><span class="line">     </span><br><span class="line">     Service s = <span class="keyword">new</span> Service(mParseServiceArgs, <span class="keyword">new</span> ServiceInfo());</span><br><span class="line">     <span class="keyword">if</span> (outError[<span class="number">0</span>] != <span class="keyword">null</span>) &#123;</span><br><span class="line">         sa.recycle();</span><br><span class="line">         <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">boolean</span> setExported = sa.hasValue(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_exported);</span><br><span class="line">     <span class="keyword">if</span> (setExported) &#123;</span><br><span class="line">         s.info.exported = sa.getBoolean(</span><br><span class="line">                 com.android.internal.R.styleable.AndroidManifestService_exported, <span class="keyword">false</span>);</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     String str = sa.getNonConfigurationString(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_permission, <span class="number">0</span>);</span><br><span class="line">     <span class="keyword">if</span> (str == <span class="keyword">null</span>) &#123;</span><br><span class="line">         s.info.permission = owner.applicationInfo.permission;</span><br><span class="line">     &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">         s.info.permission = str.length() &gt; <span class="number">0</span> ? str.toString().intern() : <span class="keyword">null</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     s.info.flags = <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_stopWithTask,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         s.info.flags |= ServiceInfo.FLAG_STOP_WITH_TASK;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_isolatedProcess,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         s.info.flags |= ServiceInfo.FLAG_ISOLATED_PROCESS;</span><br><span class="line">     &#125;</span><br><span class="line">     <span class="keyword">if</span> (sa.getBoolean(</span><br><span class="line">             com.android.internal.R.styleable.AndroidManifestService_singleUser,</span><br><span class="line">             <span class="keyword">false</span>)) &#123;</span><br><span class="line">         s.info.flags |= ServiceInfo.FLAG_SINGLE_USER;</span><br><span class="line">         <span class="keyword">if</span> (s.info.exported &amp;&amp; (flags &amp; PARSE_IS_PRIVILEGED) == <span class="number">0</span>) &#123;</span><br><span class="line">             Slog.w(TAG, <span class="string">"Service exported request ignored due to singleUser: "</span></span><br><span class="line">                     + s.className + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                     + parser.getPositionDescription());</span><br><span class="line">             s.info.exported = <span class="keyword">false</span>;</span><br><span class="line">             setExported = <span class="keyword">true</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     sa.recycle();</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> ((owner.applicationInfo.privateFlags&amp;ApplicationInfo.PRIVATE_FLAG_CANT_SAVE_STATE)</span><br><span class="line">             != <span class="number">0</span>) &#123;</span><br><span class="line">         <span class="comment">// A heavy-weight application can not have services in its main process</span></span><br><span class="line">         <span class="comment">// We can do direct compare because we intern all strings.</span></span><br><span class="line">         <span class="keyword">if</span> (s.info.processName == owner.packageName) &#123;</span><br><span class="line">             outError[<span class="number">0</span>] = <span class="string">"Heavy-weight applications can not have services in main process"</span>;</span><br><span class="line">             <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line">     </span><br><span class="line">     <span class="keyword">int</span> outerDepth = parser.getDepth();</span><br><span class="line">     <span class="keyword">int</span> type;</span><br><span class="line">     <span class="keyword">while</span> ((type=parser.next()) != XmlPullParser.END_DOCUMENT</span><br><span class="line">            &amp;&amp; (type != XmlPullParser.END_TAG</span><br><span class="line">                    || parser.getDepth() &gt; outerDepth)) &#123;</span><br><span class="line">         <span class="keyword">if</span> (type == XmlPullParser.END_TAG || type == XmlPullParser.TEXT) &#123;</span><br><span class="line">             <span class="keyword">continue</span>;</span><br><span class="line">         &#125;</span><br><span class="line"></span><br><span class="line">         <span class="keyword">if</span> (parser.getName().equals(<span class="string">"intent-filter"</span>)) &#123;</span><br><span class="line">             ServiceIntentInfo intent = <span class="keyword">new</span> ServiceIntentInfo(s);</span><br><span class="line">             <span class="keyword">if</span> (!parseIntent(res, parser, attrs, <span class="keyword">true</span>, <span class="keyword">false</span>, intent, outError)) &#123;</span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line"></span><br><span class="line">             s.intents.add(intent);</span><br><span class="line">         &#125; <span class="keyword">else</span> <span class="keyword">if</span> (parser.getName().equals(<span class="string">"meta-data"</span>)) &#123;</span><br><span class="line">             <span class="keyword">if</span> ((s.metaData=parseMetaData(res, parser, attrs, s.metaData,</span><br><span class="line">                     outError)) == <span class="keyword">null</span>) &#123;</span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">             <span class="keyword">if</span> (!RIGID_PARSER) &#123;</span><br><span class="line">                 Slog.w(TAG, <span class="string">"Unknown element under &lt;service&gt;: "</span></span><br><span class="line">                         + parser.getName() + <span class="string">" at "</span> + mArchiveSourcePath + <span class="string">" "</span></span><br><span class="line">                         + parser.getPositionDescription());</span><br><span class="line">                 XmlUtils.skipCurrentTag(parser);</span><br><span class="line">                 <span class="keyword">continue</span>;</span><br><span class="line">             &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                 outError[<span class="number">0</span>] = <span class="string">"Bad element under &lt;service&gt;: "</span> + parser.getName();</span><br><span class="line">                 <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">             &#125;</span><br><span class="line">         &#125;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">if</span> (!setExported) &#123;</span><br><span class="line">         s.info.exported = s.intents.size() &gt; <span class="number">0</span>;</span><br><span class="line">     &#125;</span><br><span class="line"></span><br><span class="line">     <span class="keyword">return</span> s;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>android 系统中的PackageManagerService 代码很长，篇幅有限，只是拿对app解析部分进行举例说明解释器模式的具体应用<br>优点：灵活，适合扩展，扩展只需要增加对应的解释器。<br>缺点：很类似java 对xml的解析，DOM,SAX等需要逐条解析，每一条文法至少对应一个解释器，文件类会增多。若构建的抽象语法树复杂的话，会导致维护困难。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/解释器模式实现与研究/" data-id="ckgur4yls004w4z3klo38inxm" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-跨进程通讯之AIDL总结实现" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/跨进程通讯之AIDL总结实现/" class="article-date">
  <time datetime="2017-12-30T13:10:20.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Android/">Android</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/跨进程通讯之AIDL总结实现/">跨进程通讯之AIDL总结实现</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Linux中传统的跨进程通讯方式又很多，比如socket、信号量、管道、内存共享、消息队列，Android 是基于Linux,Android 系统设计了一个新的通讯机制，socket开销大，管道和队列拷贝次数多，而且Binder 考虑到的传输的安全性，但Binder 机制很庞大，google android 人员考虑到了这些情况，提供了一个简便的跨进程方式，应用开发者编写Binder Service 提供了AIDL,全程Android Interface Description Language,即Android接口描述语言，下面通过一个之前工作中的下载服务独立进程例子模拟下这个过程。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>android 系统中 Binder 跨进程通讯机制，下面是通过aidl方式实现，代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : </span></span><br><span class="line"><span class="comment"> * time   : 2017/12/22</span></span><br><span class="line"><span class="comment"> * desc   : download interface</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IDownload</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">onPause</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">onStop</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : </span></span><br><span class="line"><span class="comment"> * time   : 2017/12/22</span></span><br><span class="line"><span class="comment"> * desc   :</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadBinder</span> <span class="keyword">extends</span> <span class="title">Binder</span> <span class="keyword">implements</span> <span class="title">IDownload</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : </span></span><br><span class="line"><span class="comment"> * time   : 2017/12/22</span></span><br><span class="line"><span class="comment"> * desc   : 构建下载服务</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadService</span> <span class="keyword">extends</span> <span class="title">Service</span></span>&#123;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> IBinder <span class="title">onBind</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> DownloadBinder();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : </span></span><br><span class="line"><span class="comment"> * time   : 2017/12/22</span></span><br><span class="line"><span class="comment"> * desc   : test</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadTestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bind</span>(R.id.startBt)</span><br><span class="line">    Button startBt;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.pauserBt)</span><br><span class="line">    Button pauserBt;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.stopBt)</span><br><span class="line">    Button stopBt;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.stateTv)</span><br><span class="line">    TextView stateTv;</span><br><span class="line">    <span class="keyword">private</span> DownloadBinder downloadBinder;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_download);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        ServiceConnection connection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line">                downloadBinder = (DownloadBinder) service;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(DownloadTestActivity.<span class="keyword">this</span>,DownloadService.class);</span><br><span class="line"></span><br><span class="line">        bindService(intent, connection, BIND_AUTO_CREATE);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClick</span>(&#123;R.id.startBt, R.id.pauserBt, R.id.stopBt&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewClicked</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.startBt:</span><br><span class="line">                stateTv.setText(<span class="string">"download start :"</span>+downloadBinder.start());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.pauserBt:</span><br><span class="line">                stateTv.setText(<span class="string">"download pause :"</span>+downloadBinder.onPause());</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.stopBt:</span><br><span class="line">                stateTv.setText(<span class="string">"download stop :"</span>+downloadBinder.onStop());</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>上面的下载服务在一个进程中运行，若分离此下载进行如下：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">service</span> <span class="attr">android:name</span>=<span class="string">".download.DownloadService"</span></span></span><br><span class="line"><span class="tag">         <span class="attr">android:process</span>=<span class="string">"com.bei.download"</span></span></span><br><span class="line"><span class="tag">/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>上面的程序会报错<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">java.lang.ClassCastException: android.os.BinderProxy cannot be cast to com.bei.test.download.DownloadBinder</span><br><span class="line">    at com.bei.test.download.DownloadTestActivity$<span class="number">1</span>.onServiceConnected(DownloadTestActivity.java:<span class="number">48</span>)</span><br><span class="line">    at android.app.LoadedApk$ServiceDispatcher.doConnected(LoadedApk.java:<span class="number">1453</span>)</span><br><span class="line">    at android.app.LoadedApk$ServiceDispatcher$RunConnection.run(LoadedApk.java:<span class="number">1481</span>)</span><br><span class="line">    at android.os.Handler.handleCallback(Handler.java:<span class="number">751</span>)</span><br><span class="line">    at android.os.Handler.dispatchMessage(Handler.java:<span class="number">95</span>)</span><br><span class="line">    at android.os.Looper.loop(Looper.java:<span class="number">154</span>)</span><br><span class="line">    at android.app.ActivityThread.main(ActivityThread.java:<span class="number">6119</span>)</span><br><span class="line">    at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">    at com.android.internal.os.ZygoteInit$MethodAndArgsCaller.run(ZygoteInit.java:<span class="number">886</span>)</span><br><span class="line">    at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:<span class="number">776</span>)</span><br></pre></td></tr></table></figure></p>
<p>提示不能进行类关系的转化，因为他们现在不在同一个进程中了。<br>项目右键创建下载对应aidl 接口，as会在main/main/aidl/xxxpackage/*.aidl 生成对于的aidl文件，修改这个文件里面的接口方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// IDownloadAIDL.aidl</span></span><br><span class="line"><span class="keyword">package</span> com.bei.test.download;</span><br><span class="line"></span><br><span class="line"><span class="comment">// Declare any non-default types here with import statements</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">IDownloadAIDL</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">start</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">onPause</span><span class="params">()</span></span>;</span><br><span class="line">    </span><br><span class="line">     <span class="function"><span class="keyword">boolean</span> <span class="title">onStop</span><span class="params">()</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DownloadBinder 类修改继承子上面的aidl 接口<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : </span></span><br><span class="line"><span class="comment"> * time   : 2017/12/22</span></span><br><span class="line"><span class="comment"> * desc   :</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadBinder</span> <span class="keyword">extends</span> <span class="title">IDownloadAIDL</span>.<span class="title">Stub</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onPause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onStop</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>DownloadService 不变，只是修改继承关系搞定了对服务端的修改，客户端仅是serviceconnection对象的onServiceConnected方法中获取Binder 的方式不同，即通过aidl 获取Binder<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span><br><span class="line"> <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line"><span class="comment">//    downloadBinder = (DownloadBinder) service;</span></span><br><span class="line">      mIDownloadAIDL = IDownloadAIDL.Stub.asInterface(service); <span class="comment">//修改成通过aidl 接口获取binder</span></span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>通过aidl 的Stub.asInterface获取一个IDownloadAIDL，通过IDownloadAIDL调用服务端的DownloadBinder对应的函数方法，客户端代码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail :</span></span><br><span class="line"><span class="comment"> * time   : 2017/12/22</span></span><br><span class="line"><span class="comment"> * desc   : test</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DownloadTestActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Bind</span>(R.id.startBt)</span><br><span class="line">    Button startBt;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.pauserBt)</span><br><span class="line">    Button pauserBt;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.stopBt)</span><br><span class="line">    Button stopBt;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.stateTv)</span><br><span class="line">    TextView stateTv;</span><br><span class="line">    <span class="keyword">private</span> DownloadBinder downloadBinder;</span><br><span class="line">    <span class="keyword">private</span> IDownloadAIDL mIDownloadAIDL;</span><br><span class="line">    <span class="keyword">private</span> ServiceConnection mServiceConnection;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_download);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//downloadBinder = (DownloadBinder) service;</span></span><br><span class="line">        mServiceConnection = <span class="keyword">new</span> ServiceConnection() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceConnected</span><span class="params">(ComponentName name, IBinder service)</span> </span>&#123;</span><br><span class="line"><span class="comment">//                downloadBinder = (DownloadBinder) service;</span></span><br><span class="line">                mIDownloadAIDL = IDownloadAIDL.Stub.asInterface(service); <span class="comment">//修改成通过aidl 接口获取binder</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onServiceDisconnected</span><span class="params">(ComponentName name)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(DownloadTestActivity.<span class="keyword">this</span>,DownloadService.class);</span><br><span class="line"></span><br><span class="line">        bindService(intent, mServiceConnection, BIND_AUTO_CREATE);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClick</span>(&#123;R.id.startBt, R.id.pauserBt, R.id.stopBt&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewClicked</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.startBt:</span><br><span class="line"><span class="comment">//                stateTv.setText("download start :"+downloadBinder.start());</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stateTv.setText(<span class="string">"download start :"</span>+mIDownloadAIDL.start());<span class="comment">//aidl 调用start（）</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.pauserBt:</span><br><span class="line"><span class="comment">//                stateTv.setText("download pause :"+downloadBinder.onPause());</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stateTv.setText(<span class="string">"download pause :"</span>+mIDownloadAIDL.onPause());<span class="comment">//aidl 调用start（）</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.stopBt:</span><br><span class="line"><span class="comment">//                stateTv.setText("download stop :"+downloadBinder.onStop());</span></span><br><span class="line">                <span class="keyword">try</span> &#123;</span><br><span class="line">                    stateTv.setText(<span class="string">"download stop :"</span>+mIDownloadAIDL.onStop());<span class="comment">//aidl 调用start（）</span></span><br><span class="line">                &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDestroy</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onDestroy();</span><br><span class="line">        unbindService(mServiceConnection);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>从上面的例子可以看出，服务端与客户端以及接口的定义运用了代理模式，利用android 的binder 封装的aidl ，用户并不关系底层的Binder Driver 等的复杂实现，自动化生成AIDL接口文件，用户修改对应的需要通讯的函数方法，在service 连接获取binder修改成通过aidl ,而aidl 再去调用具体的binder 操作，很大程度上简化了android 的跨进程实现难度。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/跨进程通讯之AIDL总结实现/" data-id="ckgur4ylq004r4z3kgzu84gex" class="article-share-link">Share</a>
      
      
    </footer>
  </div>
  
</article>


  
    <article id="post-迭代器模式实现与研究" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/迭代器模式实现与研究/" class="article-date">
  <time datetime="2017-12-30T13:06:45.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Design-Pattern/">Design Pattern</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/迭代器模式实现与研究/">迭代器模式实现与研究</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>提供了一种方法顺序访问一个聚合对象中的各个元素，而又不暴露其内部的表示。</p>
<h2 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h2><p>迭代器模式又称为游标（cursor）模式，源自于容器类的访问，比如java 中的list ，map 数组等，将遍历的方法封装到容器中，方式容器类的内部细节暴露，因此产生了迭代器模式</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>说到游标，首先想到的是android 中的数据库中的cursor，下面是通过ContentProvider 调用数据库操作例子来纵观整个过程：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : </span></span><br><span class="line"><span class="comment"> * time   : 2017/12/20</span></span><br><span class="line"><span class="comment"> * desc   : 数据库管理类</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DBHelper</span> <span class="keyword">extends</span> <span class="title">SQLiteOpenHelper</span> </span>&#123;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">DBHelper</span><span class="params">(Context context, String name, SQLiteDatabase.CursorFactory factory, <span class="keyword">int</span> version)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, name, <span class="keyword">null</span>, version);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(SQLiteDatabase db)</span> </span>&#123;</span><br><span class="line">        db.execSQL(<span class="string">"CREATE TABLE table_fav (_id INTEGER PRIMARY KEY AUTOINCREMENT,name TEXT,age TEXT)"</span>);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onUpgrade</span><span class="params">(SQLiteDatabase db, <span class="keyword">int</span> oldVersion, <span class="keyword">int</span> newVersion)</span> </span>&#123;</span><br><span class="line">        db.execSQL(<span class="string">"DROP TABLE IF EXISTS table_fav"</span>);</span><br><span class="line">        onCreate(db);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail :</span></span><br><span class="line"><span class="comment"> * time   : 2017/12/20</span></span><br><span class="line"><span class="comment"> * desc   : 对外提供数据接口类</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DataProvider</span> <span class="keyword">extends</span> <span class="title">ContentProvider</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> DBHelper mDBHelper;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_NAME = <span class="string">"favor.db"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String DB_TABLE = <span class="string">"table_fav"</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> DB_VERSION = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> SQLiteDatabase db;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">onCreate</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mDBHelper = <span class="keyword">new</span> DBHelper(getContext(), DB_NAME, <span class="keyword">null</span>, DB_VERSION);</span><br><span class="line">        db = mDBHelper.getWritableDatabase();</span><br><span class="line">        <span class="keyword">if</span> (db == <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Cursor <span class="title">query</span><span class="params">(@NonNull Uri uri, @Nullable String[] projection, @Nullable String selection, @Nullable String[] selectionArgs, @Nullable String sortOrder)</span> </span>&#123;</span><br><span class="line"><span class="comment">//        SQLiteDatabase db = mDBHelper.getReadableDatabase();</span></span><br><span class="line">        <span class="keyword">return</span> db.query(DB_TABLE, projection, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getType</span><span class="params">(@NonNull Uri uri)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Uri <span class="title">insert</span><span class="params">(@NonNull Uri uri, @Nullable ContentValues values)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">long</span> id = db.insert(DB_TABLE,<span class="keyword">null</span>,values);</span><br><span class="line">        <span class="keyword">if</span> (id &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Uri newUri = ContentUris.withAppendedId(Favor.CONTENT_URI,id);</span><br><span class="line">            getContext().getContentResolver().notifyChange(newUri,<span class="keyword">null</span>);</span><br><span class="line">            <span class="keyword">return</span> newUri;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">throw</span>  <span class="keyword">new</span> SQLException(<span class="string">"failed to insert row into"</span> +uri);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">delete</span><span class="params">(@NonNull Uri uri, @Nullable String selection, @Nullable String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">update</span><span class="params">(@NonNull Uri uri, @Nullable ContentValues values, @Nullable String selection, @Nullable String[] selectionArgs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail :</span></span><br><span class="line"><span class="comment"> * time   : 2017/12/21</span></span><br><span class="line"><span class="comment"> * desc   : 常量</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Favor</span> </span>&#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String AUTHORITY = <span class="string">"com.bei.test.db.DataProvider"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String PATH = <span class="string">"table_fav"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String CONTENT_URL_STRING = <span class="string">"content://"</span> +AUTHORITY +<span class="string">"/"</span>+PATH;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> Uri CONTENT_URI = Uri.parse(CONTENT_URL_STRING);</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_NAME = <span class="string">"name"</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String KEY_AGE = <span class="string">"age"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * author : lzb</span></span><br><span class="line"><span class="comment"> * e-mail : lizhanbei@cgtn.com</span></span><br><span class="line"><span class="comment"> * time   : 2017/12/20</span></span><br><span class="line"><span class="comment"> * desc   : 测试类</span></span><br><span class="line"><span class="comment"> * version: 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ContentResolverDemoActivity</span> <span class="keyword">extends</span> <span class="title">Activity</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String[] PROJECTION = <span class="keyword">new</span> String[]&#123;<span class="string">"name"</span>, <span class="string">"age"</span>&#125;;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.nameTv)</span><br><span class="line">    EditText nameTv;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.ageTv)</span><br><span class="line">    EditText ageTv;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.addBtn)</span><br><span class="line">    Button addBtn;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.queryBtn)</span><br><span class="line">    Button queryBtn;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.resultTv)</span><br><span class="line">    TextView resultTv;</span><br><span class="line">    <span class="meta">@Bind</span>(R.id.resultUrl)</span><br><span class="line">    TextView resultUrl;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(@Nullable Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line">        setContentView(R.layout.activity_main09);</span><br><span class="line">        ButterKnife.bind(<span class="keyword">this</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@OnClick</span>(&#123;R.id.addBtn, R.id.queryBtn&#125;)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onViewClicked</span><span class="params">(View view)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">switch</span> (view.getId()) &#123;</span><br><span class="line">            <span class="keyword">case</span> R.id.addBtn:</span><br><span class="line">                ContentValues contentValues = <span class="keyword">new</span> ContentValues();</span><br><span class="line">                contentValues.put(Favor.KEY_NAME, nameTv.getText().toString());</span><br><span class="line">                contentValues.put(Favor.KEY_AGE, ageTv.getText().toString());</span><br><span class="line"></span><br><span class="line">                Uri newUrl = <span class="keyword">this</span>.getContentResolver().insert(Favor.CONTENT_URI, contentValues);</span><br><span class="line"></span><br><span class="line">                resultUrl.setText(<span class="string">"添加成功 ，URI:"</span> + newUrl);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> R.id.queryBtn:</span><br><span class="line">                Cursor cursor = getContentResolver().query(Favor.CONTENT_URI, PROJECTION, <span class="keyword">null</span>, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">                String msg = <span class="string">""</span>;</span><br><span class="line">                cursor.moveToFirst();</span><br><span class="line">                <span class="keyword">do</span> &#123;</span><br><span class="line">                    msg += <span class="string">"name: "</span> + cursor.getString(<span class="number">0</span>);</span><br><span class="line">                    msg += <span class="string">"age: "</span> + cursor.getString(<span class="number">1</span>)+<span class="string">"\n"</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">                &#125; <span class="keyword">while</span> (cursor.moveToNext());</span><br><span class="line">                cursor.close();</span><br><span class="line"></span><br><span class="line">                resultTv.setText(msg);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>使用ContentProvider的时候，不要忘记AndroidManifest.xml中注册声明<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:authorities</span>=<span class="string">"com.bei.test.db.DataProvider"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:name</span>=<span class="string">".db.DataProvider"</span>/&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>运行结果如下：</p>
<p><img src="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202017-12-21%20下午2.11.54.png" width="400"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>使用了SQLiteOpenHelper 的query 方法查询，最终返回一个cursor 的游标对象，这其实就是一个迭代器，通过遍历游标的位置进行数据的遍历和查询。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>它的存在弱化了容器类与遍历算法之前的关系，很多语言比如java python等自身实现了迭代器功能，对于开发者而言很少自己去实现迭代器。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/迭代器模式实现与研究/" data-id="ckgur4yls004z4z3khmjzu858" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-责任链模式实现与研究" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/责任链模式实现与研究/" class="article-date">
  <time datetime="2017-12-30T13:04:42.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Design-Pattern/">Design Pattern</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/责任链模式实现与研究/">责任链模式实现与研究</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>有多个对象，每个对象持有下一个对象的引用，形成一条链，请求在这条链上传递，直到某一对象决定处理该请求，但是发出者并不清楚最终哪个对象会处理该请求。</p>
<h2 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h2><p>android 系统中比较类似的实现是对事件的分发处理，当用户接触屏幕时候，android 将事件对象从viewtree 的顶部至上而下的分发传递，下面主要分析下ViewGroup 中是如何派发子view的，ViewGroup 中执行事件派发的方法是dispatchTouchEvent 方法，源码实现如下。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>ViewGroup 中的部分源码如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br></pre></td><td class="code"><pre><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">if</span> (mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mInputEventConsistencyVerifier.onTouchEvent(ev, <span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If the event targets the accessibility focused view and this is it, start</span></span><br><span class="line">       <span class="comment">// normal event dispatch. Maybe a descendant is what will handle the click.</span></span><br><span class="line">       <span class="keyword">if</span> (ev.isTargetAccessibilityFocus() &amp;&amp; isAccessibilityFocusedViewOrHost()) &#123;</span><br><span class="line">           ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">boolean</span> handled = <span class="keyword">false</span>;</span><br><span class="line">       <span class="keyword">if</span> (onFilterTouchEventForSecurity(ev)) &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> action = ev.getAction();</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">int</span> actionMasked = action &amp; MotionEvent.ACTION_MASK;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Handle an initial down.处理了点击down的事件</span></span><br><span class="line">           <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">               <span class="comment">// Throw away all previous state when starting a new touch gesture.</span></span><br><span class="line">               <span class="comment">// The framework may have dropped the up or cancel event for the previous gesture</span></span><br><span class="line">               <span class="comment">// due to an app switch, ANR, or some other state change.</span></span><br><span class="line">               cancelAndClearTouchTargets(ev);</span><br><span class="line">               resetTouchState();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Check for interception.</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">           <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                   || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">               <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">       </span><br><span class="line">                   intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                   ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   intercepted = <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">               <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">               intercepted = <span class="keyword">true</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// If intercepted, start normal event dispatch. Also if there is already</span></span><br><span class="line">           <span class="comment">// a view that is handling the gesture, do normal event dispatch.</span></span><br><span class="line">           <span class="keyword">if</span> (intercepted || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">               ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Check for cancelation.</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> canceled = resetCancelNextUpFlag(<span class="keyword">this</span>)</span><br><span class="line">                   || actionMasked == MotionEvent.ACTION_CANCEL;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Update list of touch targets for pointer down, if needed.</span></span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">boolean</span> split = (mGroupFlags &amp; FLAG_SPLIT_MOTION_EVENTS) != <span class="number">0</span>;</span><br><span class="line">           TouchTarget newTouchTarget = <span class="keyword">null</span>;</span><br><span class="line">           <span class="keyword">boolean</span> alreadyDispatchedToNewTouchTarget = <span class="keyword">false</span>;</span><br><span class="line">          <span class="comment">// 如果事件没有被取消或拦截</span></span><br><span class="line">           <span class="keyword">if</span> (!canceled &amp;&amp; !intercepted) &#123;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// If the event is targeting accessiiblity focus we give it to the</span></span><br><span class="line">               <span class="comment">// view that has accessibility focus and if it does not handle it</span></span><br><span class="line">               <span class="comment">// we clear the flag and dispatch the event to all children as usual.</span></span><br><span class="line">               <span class="comment">// We are looking up the accessibility focused host to avoid keeping</span></span><br><span class="line">               <span class="comment">// state since these events are very rare.</span></span><br><span class="line">               View childWithAccessibilityFocus = ev.isTargetAccessibilityFocus()</span><br><span class="line">                       ? findChildWithAccessibilityFocus() : <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                       || (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_DOWN)</span><br><span class="line">                       || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex(); <span class="comment">// always 0 for down</span></span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> idBitsToAssign = split ? <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex)</span><br><span class="line">                           : TouchTarget.ALL_POINTER_IDS;</span><br><span class="line"></span><br><span class="line">                   <span class="comment">// Clean up earlier touch targets for this pointer id in case they</span></span><br><span class="line">                   <span class="comment">// have become out of sync.</span></span><br><span class="line">                   removePointersFromTouchTargets(idBitsToAssign);</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> childrenCount = mChildrenCount;</span><br><span class="line">                   <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; childrenCount != <span class="number">0</span>) &#123;</span><br><span class="line">                       <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(actionIndex);</span><br><span class="line">                       <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(actionIndex);</span><br><span class="line">                       <span class="comment">// Find a child that can receive the event.</span></span><br><span class="line">                       <span class="comment">// Scan children from front to back.</span></span><br><span class="line">                       <span class="comment">// 这里自上而下对子节点进行扫描，寻找可以接受事件的子view</span></span><br><span class="line">                       <span class="keyword">final</span> ArrayList&lt;View&gt; preorderedList = buildOrderedChildList();</span><br><span class="line">                       <span class="keyword">final</span> <span class="keyword">boolean</span> customOrder = preorderedList == <span class="keyword">null</span></span><br><span class="line">                               &amp;&amp; isChildrenDrawingOrderEnabled();</span><br><span class="line">                       <span class="keyword">final</span> View[] children = mChildren;</span><br><span class="line">                       <span class="keyword">for</span> (<span class="keyword">int</span> i = childrenCount - <span class="number">1</span>; i &gt;= <span class="number">0</span>; i--) &#123;</span><br><span class="line">                           <span class="keyword">final</span> <span class="keyword">int</span> childIndex = customOrder</span><br><span class="line">                                   ? getChildDrawingOrder(childrenCount, i) : i;</span><br><span class="line">                           <span class="keyword">final</span> View child = (preorderedList == <span class="keyword">null</span>)</span><br><span class="line">                                   ? children[childIndex] : preorderedList.get(childIndex);</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// If there is a view that has accessibility focus we want it</span></span><br><span class="line">                           <span class="comment">// to get the event first and if not handled we will perform a</span></span><br><span class="line">                           <span class="comment">// normal dispatch. We may do a double iteration but this is</span></span><br><span class="line">                           <span class="comment">// safer given the timeframe.</span></span><br><span class="line">                           <span class="keyword">if</span> (childWithAccessibilityFocus != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               <span class="keyword">if</span> (childWithAccessibilityFocus != child) &#123;</span><br><span class="line">                                   <span class="keyword">continue</span>;</span><br><span class="line">                               &#125;</span><br><span class="line">                               childWithAccessibilityFocus = <span class="keyword">null</span>;</span><br><span class="line">                               i = childrenCount - <span class="number">1</span>;</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           <span class="keyword">if</span> (!canViewReceivePointerEvents(child)</span><br><span class="line">                                   || !isTransformedTouchPointInView(x, y, child, <span class="keyword">null</span>)) &#123;</span><br><span class="line">                               ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                               <span class="keyword">continue</span>;</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           newTouchTarget = getTouchTarget(child);</span><br><span class="line">                           <span class="keyword">if</span> (newTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                               <span class="comment">// Child is already receiving touch within its bounds.</span></span><br><span class="line">                               <span class="comment">// Give it the new pointer in addition to the ones it is handling.</span></span><br><span class="line">                               newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                               <span class="keyword">break</span>;</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           resetCancelNextUpFlag(child);</span><br><span class="line">                           <span class="comment">//如果子元素仍旧是一个viewGroup,则递归重复此过程</span></span><br><span class="line">                           <span class="comment">//如果子元素是一个view，则调用子view 的dispathTouchEvent,并最终由onTouchEvent 处理</span></span><br><span class="line">                           <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, <span class="keyword">false</span>, child, idBitsToAssign)) &#123;</span><br><span class="line">                               <span class="comment">// Child wants to receive touch within its bounds.</span></span><br><span class="line">                               mLastTouchDownTime = ev.getDownTime();</span><br><span class="line">                               <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) &#123;</span><br><span class="line">                                   <span class="comment">// childIndex points into presorted list, find original index</span></span><br><span class="line">                                   <span class="keyword">for</span> (<span class="keyword">int</span> j = <span class="number">0</span>; j &lt; childrenCount; j++) &#123;</span><br><span class="line">                                       <span class="keyword">if</span> (children[childIndex] == mChildren[j]) &#123;</span><br><span class="line">                                           mLastTouchDownIndex = j;</span><br><span class="line">                                           <span class="keyword">break</span>;</span><br><span class="line">                                       &#125;</span><br><span class="line">                                   &#125;</span><br><span class="line">                               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                                   mLastTouchDownIndex = childIndex;</span><br><span class="line">                               &#125;</span><br><span class="line">                               mLastTouchDownX = ev.getX();</span><br><span class="line">                               mLastTouchDownY = ev.getY();</span><br><span class="line">                               newTouchTarget = addTouchTarget(child, idBitsToAssign);</span><br><span class="line">                               alreadyDispatchedToNewTouchTarget = <span class="keyword">true</span>;</span><br><span class="line">                               <span class="keyword">break</span>;</span><br><span class="line">                           &#125;</span><br><span class="line"></span><br><span class="line">                           <span class="comment">// The accessibility focus didn't handle the event, so clear</span></span><br><span class="line">                           <span class="comment">// the flag and do a normal dispatch to all children.</span></span><br><span class="line">                           ev.setTargetAccessibilityFocus(<span class="keyword">false</span>);</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">if</span> (preorderedList != <span class="keyword">null</span>) preorderedList.clear();</span><br><span class="line">                   &#125;</span><br><span class="line"></span><br><span class="line">                   <span class="keyword">if</span> (newTouchTarget == <span class="keyword">null</span> &amp;&amp; mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">                       <span class="comment">// Did not find a child to receive the event.</span></span><br><span class="line">                       <span class="comment">// Assign the pointer to the least recently added target.</span></span><br><span class="line">                       newTouchTarget = mFirstTouchTarget;</span><br><span class="line">                       <span class="keyword">while</span> (newTouchTarget.next != <span class="keyword">null</span>) &#123;</span><br><span class="line">                           newTouchTarget = newTouchTarget.next;</span><br><span class="line">                       &#125;</span><br><span class="line">                       newTouchTarget.pointerIdBits |= idBitsToAssign;</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Dispatch to touch targets.</span></span><br><span class="line">           <span class="keyword">if</span> (mFirstTouchTarget == <span class="keyword">null</span>) &#123;</span><br><span class="line">               <span class="comment">// No touch targets so treat this as an ordinary view.</span></span><br><span class="line">               handled = dispatchTransformedTouchEvent(ev, canceled, <span class="keyword">null</span>,</span><br><span class="line">                       TouchTarget.ALL_POINTER_IDS);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// Dispatch to touch targets, excluding the new touch target if we already</span></span><br><span class="line">               <span class="comment">// dispatched to it.  Cancel touch targets if necessary.</span></span><br><span class="line">               TouchTarget predecessor = <span class="keyword">null</span>;</span><br><span class="line">               TouchTarget target = mFirstTouchTarget;</span><br><span class="line">               <span class="keyword">while</span> (target != <span class="keyword">null</span>) &#123;</span><br><span class="line">                   <span class="keyword">final</span> TouchTarget next = target.next;</span><br><span class="line">                   <span class="keyword">if</span> (alreadyDispatchedToNewTouchTarget &amp;&amp; target == newTouchTarget) &#123;</span><br><span class="line">                       handled = <span class="keyword">true</span>;</span><br><span class="line">                   &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                       <span class="keyword">final</span> <span class="keyword">boolean</span> cancelChild = resetCancelNextUpFlag(target.child)</span><br><span class="line">                               || intercepted;</span><br><span class="line">                       <span class="keyword">if</span> (dispatchTransformedTouchEvent(ev, cancelChild,</span><br><span class="line">                               target.child, target.pointerIdBits)) &#123;</span><br><span class="line">                           handled = <span class="keyword">true</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                       <span class="keyword">if</span> (cancelChild) &#123;</span><br><span class="line">                           <span class="keyword">if</span> (predecessor == <span class="keyword">null</span>) &#123;</span><br><span class="line">                               mFirstTouchTarget = next;</span><br><span class="line">                           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                               predecessor.next = next;</span><br><span class="line">                           &#125;</span><br><span class="line">                           target.recycle();</span><br><span class="line">                           target = next;</span><br><span class="line">                           <span class="keyword">continue</span>;</span><br><span class="line">                       &#125;</span><br><span class="line">                   &#125;</span><br><span class="line">                   predecessor = target;</span><br><span class="line">                   target = next;</span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="comment">// Update list of touch targets for pointer up or cancel, if needed.</span></span><br><span class="line">           <span class="keyword">if</span> (canceled</span><br><span class="line">                   || actionMasked == MotionEvent.ACTION_UP</span><br><span class="line">                   || actionMasked == MotionEvent.ACTION_HOVER_MOVE) &#123;</span><br><span class="line">               resetTouchState();</span><br><span class="line">           &#125; <span class="keyword">else</span> <span class="keyword">if</span> (split &amp;&amp; actionMasked == MotionEvent.ACTION_POINTER_UP) &#123;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> actionIndex = ev.getActionIndex();</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> idBitsToRemove = <span class="number">1</span> &lt;&lt; ev.getPointerId(actionIndex);</span><br><span class="line">               removePointersFromTouchTargets(idBitsToRemove);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">if</span> (!handled &amp;&amp; mInputEventConsistencyVerifier != <span class="keyword">null</span>) &#123;</span><br><span class="line">           mInputEventConsistencyVerifier.onUnhandledEvent(ev, <span class="number">1</span>);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">return</span> handled;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// 下面是dispatchTransformedTouchEvent 的源码</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Transforms a motion event into the coordinate space of a particular child view,</span></span><br><span class="line"><span class="comment">    * filters out irrelevant pointer ids, and overrides its action if necessary.</span></span><br><span class="line"><span class="comment">    * If child is null, assumes the MotionEvent will be sent to this ViewGroup instead.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">dispatchTransformedTouchEvent</span><span class="params">(MotionEvent event, <span class="keyword">boolean</span> cancel,</span></span></span><br><span class="line"><span class="function"><span class="params">           View child, <span class="keyword">int</span> desiredPointerIdBits)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> handled;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Canceling motions is a special case.  We don't need to perform any transformations</span></span><br><span class="line">       <span class="comment">// or filtering.  The important part is the action, not the contents.</span></span><br><span class="line">       <span class="comment">// 在事件被取消下执行下面的代码</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> oldAction = event.getAction();</span><br><span class="line">       <span class="keyword">if</span> (cancel || oldAction == MotionEvent.ACTION_CANCEL) &#123; </span><br><span class="line">           event.setAction(MotionEvent.ACTION_CANCEL);dispatchTouchEvent 方法，也就是view类</span><br><span class="line">           <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123; </span><br><span class="line">               <span class="comment">//没有子元素，调用父类的</span></span><br><span class="line">               handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">           &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">               <span class="comment">// 存在子元素则调用子元素进行事件传递轮询上面的操作</span></span><br><span class="line">               handled = child.dispatchTouchEvent(event);</span><br><span class="line">           &#125;</span><br><span class="line">           event.setAction(oldAction);</span><br><span class="line">           <span class="keyword">return</span> handled;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Calculate the number of pointers to deliver.</span></span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> oldPointerIdBits = event.getPointerIdBits();</span><br><span class="line">       <span class="keyword">final</span> <span class="keyword">int</span> newPointerIdBits = oldPointerIdBits &amp; desiredPointerIdBits;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If for some reason we ended up in an inconsistent state where it looks like we</span></span><br><span class="line">       <span class="comment">// might produce a motion event with no pointers in it, then drop the event.</span></span><br><span class="line">       <span class="keyword">if</span> (newPointerIdBits == <span class="number">0</span>) &#123;</span><br><span class="line">           <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// If the number of pointers is the same and we don't need to perform any fancy</span></span><br><span class="line">       <span class="comment">// irreversible transformations, then we can reuse the motion event for this</span></span><br><span class="line">       <span class="comment">// dispatch as long as we are careful to revert any changes we make.</span></span><br><span class="line">       <span class="comment">// Otherwise we need to make a copy.</span></span><br><span class="line">       <span class="keyword">final</span> MotionEvent transformedEvent;</span><br><span class="line">       <span class="keyword">if</span> (newPointerIdBits == oldPointerIdBits) &#123;</span><br><span class="line">           <span class="keyword">if</span> (child == <span class="keyword">null</span> || child.hasIdentityMatrix()) &#123;</span><br><span class="line">               <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   handled = <span class="keyword">super</span>.dispatchTouchEvent(event);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</span><br><span class="line">                   <span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</span><br><span class="line">                   event.offsetLocation(offsetX, offsetY);</span><br><span class="line"></span><br><span class="line">                   handled = child.dispatchTouchEvent(event);</span><br><span class="line"></span><br><span class="line">                   event.offsetLocation(-offsetX, -offsetY);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> handled;</span><br><span class="line">           &#125;</span><br><span class="line">           transformedEvent = MotionEvent.obtain(event);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           transformedEvent = event.split(newPointerIdBits);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Perform any necessary transformations and dispatch.</span></span><br><span class="line">       <span class="keyword">if</span> (child == <span class="keyword">null</span>) &#123;</span><br><span class="line">           handled = <span class="keyword">super</span>.dispatchTouchEvent(transformedEvent);</span><br><span class="line">       &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">float</span> offsetX = mScrollX - child.mLeft;</span><br><span class="line">           <span class="keyword">final</span> <span class="keyword">float</span> offsetY = mScrollY - child.mTop;</span><br><span class="line">           transformedEvent.offsetLocation(offsetX, offsetY);</span><br><span class="line">           <span class="keyword">if</span> (! child.hasIdentityMatrix()) &#123;</span><br><span class="line">               transformedEvent.transform(child.getInverseMatrix());</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           handled = child.dispatchTouchEvent(transformedEvent);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="comment">// Done.</span></span><br><span class="line">       transformedEvent.recycle();</span><br><span class="line">       <span class="keyword">return</span> handled;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>ViewGroup 的事件传递过程总结为，不断的查找子节点的可以消费此事件的过程，当view 的onTouchEvent 的返回值为false，当前view不消费这个事件，不持有。如果为true，则view消费该事件并不再向外传递了。这个过程很类似责任链，事件的分发在寻找责任者，合适的责任者消费这个事件。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>优点：请求者和处理者关系解耦<br>缺点：对链中请求处理需要遍历，处理者过多影响性能，使用递归要慎重吧。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/责任链模式实现与研究/" data-id="ckgur4ylp004p4z3klisiqrq1" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-原型模式-Prototype-实现与研究" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/12/30/原型模式-Prototype-实现与研究/" class="article-date">
  <time datetime="2017-12-30T13:03:03.000Z" itemprop="datePublished">2017-12-30</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/Design-Pattern/">Design Pattern</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/12/30/原型模式-Prototype-实现与研究/">原型模式(Prototype)实现与研究</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="定义"><a href="#定义" class="headerlink" title="定义"></a>定义</h2><p>指的是创建对象，并通过拷贝创建新的对象，分为</p>
<h2 id="场景模拟"><a href="#场景模拟" class="headerlink" title="场景模拟"></a>场景模拟</h2><p>android 中的intent实现</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><ul>
<li>android 中的intent实现<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//系统调用</span></span><br><span class="line">Intent intent = <span class="keyword">new</span> Intent(MainActivity09.<span class="keyword">this</span>,MainActivity08.class);</span><br><span class="line">startActivity(intent);</span><br><span class="line"><span class="comment">// ---------------------------------------------------------------------</span></span><br><span class="line"><span class="comment">//intent 的系统源码</span></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Create an empty intent.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Intent</span><span class="params">()</span> </span>&#123;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Copy constructor.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="title">Intent</span><span class="params">(Intent o)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.mAction = o.mAction;</span><br><span class="line">       <span class="keyword">this</span>.mData = o.mData;</span><br><span class="line">       <span class="keyword">this</span>.mType = o.mType;</span><br><span class="line">       <span class="keyword">this</span>.mPackage = o.mPackage;</span><br><span class="line">       <span class="keyword">this</span>.mComponent = o.mComponent;</span><br><span class="line">       <span class="keyword">this</span>.mFlags = o.mFlags;</span><br><span class="line">       <span class="keyword">this</span>.mContentUserHint = o.mContentUserHint;</span><br><span class="line">       <span class="keyword">if</span> (o.mCategories != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.mCategories = <span class="keyword">new</span> ArraySet&lt;String&gt;(o.mCategories);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (o.mExtras != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.mExtras = <span class="keyword">new</span> Bundle(o.mExtras);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (o.mSourceBounds != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.mSourceBounds = <span class="keyword">new</span> Rect(o.mSourceBounds);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (o.mSelector != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.mSelector = <span class="keyword">new</span> Intent(o.mSelector);</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="keyword">if</span> (o.mClipData != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.mClipData = <span class="keyword">new</span> ClipData(o.mClipData);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Override</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Object <span class="title">clone</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Intent(<span class="keyword">this</span>);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">private</span> <span class="title">Intent</span><span class="params">(Intent o, <span class="keyword">boolean</span> all)</span> </span>&#123;</span><br><span class="line">       <span class="keyword">this</span>.mAction = o.mAction;</span><br><span class="line">       <span class="keyword">this</span>.mData = o.mData;</span><br><span class="line">       <span class="keyword">this</span>.mType = o.mType;</span><br><span class="line">       <span class="keyword">this</span>.mPackage = o.mPackage;</span><br><span class="line">       <span class="keyword">this</span>.mComponent = o.mComponent;</span><br><span class="line">       <span class="keyword">if</span> (o.mCategories != <span class="keyword">null</span>) &#123;</span><br><span class="line">           <span class="keyword">this</span>.mCategories = <span class="keyword">new</span> ArraySet&lt;String&gt;(o.mCategories);</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * Make a clone of only the parts of the Intent that are relevant for</span></span><br><span class="line"><span class="comment">    * filter matching: the action, data, type, component, and categories.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   <span class="function"><span class="keyword">public</span> Intent <span class="title">cloneFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> Intent(<span class="keyword">this</span>, <span class="keyword">false</span>);</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
</li>
</ul>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>从上面的intent 的源码可以看到，clone方法并没有调用父类的super.clone方法，而是执行了new intent(this),这么做其实是考虑到clone 和new一个对象所需要的成本决定的，将之前的对象进行copy，然后在生成，就是这个流程。</p>
<h2 id="扩展"><a href="#扩展" class="headerlink" title="扩展"></a>扩展</h2><p>上面还有 startActivity(intent); 下面就分析下intent 的跳转逻辑是怎样的<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br></pre></td><td class="code"><pre><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Same as &#123;<span class="doctag">@link</span> #startActivity(Intent, Bundle)&#125; with no options</span></span><br><span class="line"><span class="comment">     * specified.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> intent The intent to start.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> android.content.ActivityNotFoundException</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> &#123;<span class="doctag">@link</span> #startActivity(Intent, Bundle)&#125;</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@see</span> #startActivityForResult</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">this</span>.startActivity(intent, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivity</span><span class="params">(Intent intent, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>, options);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// Note we want to go through this call for compatibility with</span></span><br><span class="line">            <span class="comment">// applications that may have overridden the method.</span></span><br><span class="line">            startActivityForResult(intent, -<span class="number">1</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">startActivityForResult</span><span class="params">(Intent intent, <span class="keyword">int</span> requestCode, @Nullable Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (mParent == <span class="keyword">null</span>) &#123;</span><br><span class="line">            Instrumentation.ActivityResult ar =</span><br><span class="line">                mInstrumentation.execStartActivity(</span><br><span class="line">                    <span class="keyword">this</span>, mMainThread.getApplicationThread(), mToken, <span class="keyword">this</span>,</span><br><span class="line">                    intent, requestCode, options);</span><br><span class="line">            <span class="keyword">if</span> (ar != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mMainThread.sendActivityResult(</span><br><span class="line">                    mToken, mEmbeddedID, requestCode, ar.getResultCode(),</span><br><span class="line">                    ar.getResultData());</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (requestCode &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">                <span class="comment">// If this start is requesting a result, we can avoid making</span></span><br><span class="line">                <span class="comment">// the activity visible until the result is received.  Setting</span></span><br><span class="line">                <span class="comment">// this code during onCreate(Bundle savedInstanceState) or onResume() will keep the</span></span><br><span class="line">                <span class="comment">// activity hidden during this time, to avoid flickering.</span></span><br><span class="line">                <span class="comment">// This can only be done when a result is requested because</span></span><br><span class="line">                <span class="comment">// that guarantees we will get information back when the</span></span><br><span class="line">                <span class="comment">// activity is finished, no matter what happens to it.</span></span><br><span class="line">                mStartedActivity = <span class="keyword">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            cancelInputsAndStartExitTransition(options);</span><br><span class="line">            <span class="comment">// TODO Consider clearing/flushing other event sources and events for child windows.</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (options != <span class="keyword">null</span>) &#123;</span><br><span class="line">                mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode, options);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// Note we want to go through this method for compatibility with</span></span><br><span class="line">                <span class="comment">// existing applications that may have overridden it.</span></span><br><span class="line">                mParent.startActivityFromChild(<span class="keyword">this</span>, intent, requestCode);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">public</span> ActivityResult <span class="title">execStartActivity</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            Context who, IBinder contextThread, IBinder token, Activity target,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, <span class="keyword">int</span> requestCode, Bundle options)</span> </span>&#123;</span><br><span class="line">        IApplicationThread whoThread = (IApplicationThread) contextThread;</span><br><span class="line">        Uri referrer = target != <span class="keyword">null</span> ? target.onProvideReferrer() : <span class="keyword">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (referrer != <span class="keyword">null</span>) &#123;</span><br><span class="line">            intent.putExtra(Intent.EXTRA_REFERRER, referrer);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (mActivityMonitors != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">synchronized</span> (mSync) &#123;</span><br><span class="line">                <span class="keyword">final</span> <span class="keyword">int</span> N = mActivityMonitors.size();</span><br><span class="line">                <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;N; i++) &#123;</span><br><span class="line">                    <span class="keyword">final</span> ActivityMonitor am = mActivityMonitors.get(i);</span><br><span class="line">                    <span class="keyword">if</span> (am.match(who, <span class="keyword">null</span>, intent)) &#123;</span><br><span class="line">                        am.mHits++;</span><br><span class="line">                        <span class="keyword">if</span> (am.isBlocking()) &#123;</span><br><span class="line">                            <span class="keyword">return</span> requestCode &gt;= <span class="number">0</span> ? am.getResult() : <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            intent.migrateExtraStreamToClipData();</span><br><span class="line">            intent.prepareToLeaveProcess();</span><br><span class="line"><span class="comment">//ActivityManagerNative 为一个抽象类，具体的实现在ActivityManagerService</span></span><br><span class="line">            <span class="keyword">int</span> result = ActivityManagerNative.getDefault()</span><br><span class="line">                .startActivity(whoThread, who.getBasePackageName(), intent,</span><br><span class="line">                        intent.resolveTypeIfNeeded(who.getContentResolver()),</span><br><span class="line">                        token, target != <span class="keyword">null</span> ? target.mEmbeddedID : <span class="keyword">null</span>,</span><br><span class="line">                        requestCode, <span class="number">0</span>, <span class="keyword">null</span>, options);</span><br><span class="line">            checkStartActivityResult(result, intent);</span><br><span class="line">        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> RuntimeException(<span class="string">"Failure from system"</span>, e);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ActivityManagerService 中调用了startActivityAsUser，继续调用了mStackSupervisor.startActivityMayWait</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivity</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> startActivityAsUser(caller, callingPackage, intent, resolvedType, resultTo,</span><br><span class="line">            resultWho, requestCode, startFlags, profilerInfo, options,</span><br><span class="line">            UserHandle.getCallingUserId());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">int</span> <span class="title">startActivityAsUser</span><span class="params">(IApplicationThread caller, String callingPackage,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent intent, String resolvedType, IBinder resultTo, String resultWho, <span class="keyword">int</span> requestCode,</span></span></span><br><span class="line"><span class="function"><span class="params">            <span class="keyword">int</span> startFlags, ProfilerInfo profilerInfo, Bundle options, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        enforceNotIsolatedCaller(<span class="string">"startActivity"</span>);</span><br><span class="line">        userId = handleIncomingUser(Binder.getCallingPid(), Binder.getCallingUid(), userId,</span><br><span class="line">                <span class="keyword">false</span>, ALLOW_FULL_ONLY, <span class="string">"startActivity"</span>, <span class="keyword">null</span>);</span><br><span class="line">        <span class="comment">// <span class="doctag">TODO:</span> Switch to user app stacks here.</span></span><br><span class="line">        <span class="keyword">return</span> mStackSupervisor.startActivityMayWait(caller, -<span class="number">1</span>, callingPackage, intent,</span><br><span class="line">                resolvedType, <span class="keyword">null</span>, <span class="keyword">null</span>, resultTo, resultWho, requestCode, startFlags,</span><br><span class="line">                profilerInfo, <span class="keyword">null</span>, <span class="keyword">null</span>, options, <span class="keyword">false</span>, userId, <span class="keyword">null</span>, <span class="keyword">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// ActivityStackSuper 的startActivityMayWait 部分方法，最终调用了pms 的resolveIntent 方法</span></span><br><span class="line"> <span class="keyword">try</span> &#123;</span><br><span class="line">                            ResolveInfo rInfo =</span><br><span class="line">                                AppGlobals.getPackageManager().resolveIntent(</span><br><span class="line">                                        intent, <span class="keyword">null</span>,</span><br><span class="line">                                        PackageManager.MATCH_DEFAULT_ONLY</span><br><span class="line">                                        | ActivityManagerService.STOCK_PM_FLAGS, userId);</span><br><span class="line">                            aInfo = rInfo != <span class="keyword">null</span> ? rInfo.activityInfo : <span class="keyword">null</span>;</span><br><span class="line">                            aInfo = mService.getActivityInfoForUser(aInfo, userId);</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</span><br><span class="line">                            aInfo = <span class="keyword">null</span>;</span><br><span class="line">                        &#125;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//queryIntentActivitityes  主要调用了pms de resolveIntent方法</span></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> List&lt;ResolveInfo&gt; <span class="title">queryIntentActivityOptions</span><span class="params">(ComponentName caller,</span></span></span><br><span class="line"><span class="function"><span class="params">            Intent[] specifics, String[] specificTypes, Intent intent,</span></span></span><br><span class="line"><span class="function"><span class="params">            String resolvedType, <span class="keyword">int</span> flags, <span class="keyword">int</span> userId)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (!sUserManager.exists(userId)) <span class="keyword">return</span> Collections.emptyList();</span><br><span class="line">        enforceCrossUserPermission(Binder.getCallingUid(), userId, <span class="keyword">false</span>,</span><br><span class="line">                <span class="keyword">false</span>, <span class="string">"query intent activity options"</span>);</span><br><span class="line">        <span class="keyword">final</span> String resultsAction = intent.getAction();</span><br><span class="line"></span><br><span class="line">        List&lt;ResolveInfo&gt; results = queryIntentActivities(intent, resolvedType, flags</span><br><span class="line">                | PackageManager.GET_RESOLVED_FILTER, userId);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (DEBUG_INTENT_MATCHING) &#123;</span><br><span class="line">            Log.v(TAG, <span class="string">"Query "</span> + intent + <span class="string">": "</span> + results);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">int</span> specificsPos = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">int</span> N;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// todo: note that the algorithm used here is O(N^2).  This</span></span><br><span class="line">        <span class="comment">// isn't a problem in our current environment, but if we start running</span></span><br><span class="line">        <span class="comment">// into situations where we have more than 5 or 10 matches then this</span></span><br><span class="line">        <span class="comment">// should probably be changed to something smarter...</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// First we go through and resolve each of the specific items</span></span><br><span class="line">        <span class="comment">// that were supplied, taking care of removing any corresponding</span></span><br><span class="line">        <span class="comment">// duplicate items in the generic resolve list.</span></span><br><span class="line">        <span class="keyword">if</span> (specifics != <span class="keyword">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;specifics.length; i++) &#123;</span><br><span class="line">                <span class="keyword">final</span> Intent sintent = specifics[i];</span><br><span class="line">                <span class="keyword">if</span> (sintent == <span class="keyword">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">continue</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (DEBUG_INTENT_MATCHING) &#123;</span><br><span class="line">                    Log.v(TAG, <span class="string">"Specific #"</span> + i + <span class="string">": "</span> + sintent);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                String action = sintent.getAction();</span><br><span class="line">                <span class="keyword">if</span> (resultsAction != <span class="keyword">null</span> &amp;&amp; resultsAction.equals(action)) &#123;</span><br><span class="line">                    <span class="comment">// If this action was explicitly requested, then don't</span></span><br><span class="line">                    <span class="comment">// remove things that have it.</span></span><br><span class="line">                    action = <span class="keyword">null</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                ResolveInfo ri = <span class="keyword">null</span>;</span><br><span class="line">                ActivityInfo ai = <span class="keyword">null</span>;</span><br><span class="line"></span><br><span class="line">                ComponentName comp = sintent.getComponent();</span><br><span class="line">                <span class="keyword">if</span> (comp == <span class="keyword">null</span>) &#123;</span><br><span class="line"><span class="comment">//这里最关键</span></span><br><span class="line">                    ri = resolveIntent(</span><br><span class="line">                        sintent,</span><br><span class="line">                        specificTypes != <span class="keyword">null</span> ? specificTypes[i] : <span class="keyword">null</span>,</span><br><span class="line">                            flags, userId);</span><br><span class="line">                    <span class="keyword">if</span> (ri == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (ri == mResolveInfo) &#123;</span><br><span class="line">                        <span class="comment">// ACK!  Must do something better with this.</span></span><br><span class="line">                    &#125;</span><br><span class="line">                    ai = ri.activityInfo;</span><br><span class="line">                    comp = <span class="keyword">new</span> ComponentName(ai.applicationInfo.packageName,</span><br><span class="line">                            ai.name);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    ai = getActivityInfo(comp, flags, userId);</span><br><span class="line">                    <span class="keyword">if</span> (ai == <span class="keyword">null</span>) &#123;</span><br><span class="line">                        <span class="keyword">continue</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line"> ／／queryIntentAactivity  返回了一个acitivtyinfo的对象列表</span><br><span class="line"> ResolveInfo xpResolveInfo  = querySkipCurrentProfileIntents(matchingFilters, intent,</span><br><span class="line">                        resolvedType, flags, userId);</span><br><span class="line">                <span class="keyword">if</span> (xpResolveInfo != <span class="keyword">null</span> &amp;&amp; isUserEnabled(xpResolveInfo.targetUserId)) &#123;</span><br><span class="line">                    List&lt;ResolveInfo&gt; result = <span class="keyword">new</span> ArrayList&lt;ResolveInfo&gt;(<span class="number">1</span>);</span><br><span class="line">                    result.add(xpResolveInfo);</span><br><span class="line">                    <span class="keyword">return</span> filterIfNotPrimaryUser(result, userId);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check for results in the current profile.</span></span><br><span class="line">                List&lt;ResolveInfo&gt; result = mActivities.queryIntent(</span><br><span class="line">                        intent, resolvedType, flags, userId);</span><br><span class="line"></span><br><span class="line">                <span class="comment">// Check for cross profile results.</span></span><br><span class="line">                xpResolveInfo = queryCrossProfileIntents(</span><br><span class="line">                        matchingFilters, intent, resolvedType, flags, userId);</span><br><span class="line"></span><br><span class="line">这个列表其实也就是程序入口的时候通过manifest 文件进行反射后的acitivitiy 集合</span><br><span class="line"></span><br><span class="line"> <span class="comment">// All available activities, for your resolving pleasure.</span></span><br><span class="line">    <span class="keyword">final</span> ActivityIntentResolver mActivities =</span><br><span class="line">            <span class="keyword">new</span> ActivityIntentResolver();</span><br></pre></td></tr></table></figure></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>系统启动packagemanagerservice 会解析获取到所有安装的应用的信息，构建一个信息表，用户通过intent 跳转，会根据intent 中包含的信息到这个列表中进行匹配查找，没有指定具体的查询条件的，按照模糊查询进行最后返回一个匹配列表。然后进行跳转。</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2017/12/30/原型模式-Prototype-实现与研究/" data-id="ckgur4yl0003a4z3k2sl89lub" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Java/">Java</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Config/">Config</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CustomView/">CustomView</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/">Design Pattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/media/">media</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activity/">Activity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activity-View/">Activity View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Glide/">Glide</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ImageView/">ImageView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jni/">Jni</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ndk/">Ndk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProGuard/">ProGuard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Retrofit/">Retrofit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ScaleType/">ScaleType</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clock/">clock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/media/">media</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/permission/">permission</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewgroup/">viewgroup</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Activity/" style="font-size: 13.33px;">Activity</a> <a href="/tags/Activity-View/" style="font-size: 10px;">Activity View</a> <a href="/tags/Glide/" style="font-size: 10px;">Glide</a> <a href="/tags/ImageView/" style="font-size: 10px;">ImageView</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Jni/" style="font-size: 10px;">Jni</a> <a href="/tags/Ndk/" style="font-size: 10px;">Ndk</a> <a href="/tags/ProGuard/" style="font-size: 10px;">ProGuard</a> <a href="/tags/Retrofit/" style="font-size: 16.67px;">Retrofit</a> <a href="/tags/ScaleType/" style="font-size: 10px;">ScaleType</a> <a href="/tags/clock/" style="font-size: 13.33px;">clock</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jenkins/" style="font-size: 13.33px;">jenkins</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/media/" style="font-size: 13.33px;">media</a> <a href="/tags/permission/" style="font-size: 10px;">permission</a> <a href="/tags/viewgroup/" style="font-size: 10px;">viewgroup</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/10/29/Activity如何计算view的层级深度/">Activity如何计算view的层级深度</a>
          </li>
        
          <li>
            <a href="/2020/10/28/搜索项目apk文件/">搜索项目apk文件</a>
          </li>
        
          <li>
            <a href="/2018/01/14/Ijkplayer-android端执行流程分析/">Ijkplayer android端执行流程分析</a>
          </li>
        
          <li>
            <a href="/2018/01/14/android-播放器调研分析/">android 播放器调研分析</a>
          </li>
        
          <li>
            <a href="/2017/12/30/自定义view－标签/">自定义view－标签</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 bei1999<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>