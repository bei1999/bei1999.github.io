<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Ijkplayer android端执行流程分析 | bei1999 的博客</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="前言最近项目涉及到直播流播放器，于是对b站开源的ijkplayer进行了编译，过程之中并阅读了下这个开发源码，做个笔记吧。 编译按照github 上的介绍逐步执行脚本就ok了，导入as最后的结构如下：  工程分析">
<meta name="keywords" content="media">
<meta property="og:type" content="article">
<meta property="og:title" content="Ijkplayer android端执行流程分析">
<meta property="og:url" content="http://yoursite.com/2018/01/14/Ijkplayer-android端执行流程分析/index.html">
<meta property="og:site_name" content="bei1999 的博客">
<meta property="og:description" content="前言最近项目涉及到直播流播放器，于是对b站开源的ijkplayer进行了编译，过程之中并阅读了下这个开发源码，做个笔记吧。 编译按照github 上的介绍逐步执行脚本就ok了，导入as最后的结构如下：  工程分析">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202018-01-12%20下午5.30.22.png">
<meta property="og:image" content="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202018-01-12%20下午5.42.39.png">
<meta property="og:updated_time" content="2020-10-28T14:18:56.309Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Ijkplayer android端执行流程分析">
<meta name="twitter:description" content="前言最近项目涉及到直播流播放器，于是对b站开源的ijkplayer进行了编译，过程之中并阅读了下这个开发源码，做个笔记吧。 编译按照github 上的介绍逐步执行脚本就ok了，导入as最后的结构如下：  工程分析">
<meta name="twitter:image" content="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202018-01-12%20下午5.30.22.png">
  
    <link rel="alternate" href="/atom.xml" title="bei1999 的博客" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">bei1999 的博客</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Zoeken"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://yoursite.com"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main"><article id="post-Ijkplayer-android端执行流程分析" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/14/Ijkplayer-android端执行流程分析/" class="article-date">
  <time datetime="2018-01-14T13:16:34.000Z" itemprop="datePublished">2018-01-14</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/media/">media</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 class="article-title" itemprop="name">
      Ijkplayer android端执行流程分析
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近项目涉及到直播流播放器，于是对b站开源的ijkplayer进行了编译，过程之中并阅读了下这个开发源码，做个笔记吧。</p>
<h2 id="编译"><a href="#编译" class="headerlink" title="编译"></a>编译</h2><p>按照github 上的介绍逐步执行脚本就ok了，导入as最后的结构如下：</p>
<p><img src="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202018-01-12%20下午5.30.22.png" width="400"></p>
<h2 id="工程分析"><a href="#工程分析" class="headerlink" title="工程分析"></a>工程分析</h2><a id="more"></a>
<p>在demo中发现了下面的调用播放器的代码<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// init player</span></span><br><span class="line">       IjkMediaPlayer.loadLibrariesOnce(<span class="keyword">null</span>);</span><br><span class="line">       IjkMediaPlayer.native_profileBegin(<span class="string">"libijkplayer.so"</span>);</span><br><span class="line"></span><br><span class="line">       mVideoView = (IjkVideoView) findViewById(R.id.video_view);</span><br><span class="line">       mVideoView.setMediaController(mMediaController);</span><br><span class="line">       mVideoView.setHudView(mHudView);</span><br><span class="line">       <span class="comment">// prefer mVideoPath</span></span><br><span class="line">       <span class="keyword">if</span> (mVideoPath != <span class="keyword">null</span>)</span><br><span class="line">           mVideoView.setVideoPath(mVideoPath);</span><br><span class="line">       <span class="keyword">else</span> <span class="keyword">if</span> (mVideoUri != <span class="keyword">null</span>)</span><br><span class="line">           mVideoView.setVideoURI(mVideoUri);</span><br><span class="line">       <span class="keyword">else</span> &#123;</span><br><span class="line">           Log.e(TAG, <span class="string">"Null Data Source\n"</span>);</span><br><span class="line">           finish();</span><br><span class="line">           <span class="keyword">return</span>;</span><br><span class="line">       &#125;</span><br><span class="line">       mVideoView.start();</span><br></pre></td></tr></table></figure></p>
<p>IjkVideoView 是个什么东东？部分代码截取</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkVideoView</span> <span class="keyword">extends</span> <span class="title">FrameLayout</span> <span class="keyword">implements</span> <span class="title">MediaController</span>.<span class="title">MediaPlayerControl</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> String TAG = <span class="string">"IjkVideoView"</span>;</span><br><span class="line">    <span class="comment">// settable by the client</span></span><br><span class="line">    <span class="keyword">private</span> Uri mUri;</span><br><span class="line">    <span class="keyword">private</span> Map&lt;String, String&gt; mHeaders;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// all possible internal states</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_ERROR = -<span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_IDLE = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PREPARING = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PREPARED = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PLAYING = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PAUSED = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> STATE_PLAYBACK_COMPLETED = <span class="number">5</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// mCurrentState is a VideoView object's current state.</span></span><br><span class="line">    <span class="comment">// mTargetState is the state that a method caller intends to reach.</span></span><br><span class="line">    <span class="comment">// For instance, regardless the VideoView object's current state,</span></span><br><span class="line">    <span class="comment">// calling pause() intends to bring the object to a target state</span></span><br><span class="line">    <span class="comment">// of STATE_PAUSED.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCurrentState = STATE_IDLE;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mTargetState = STATE_IDLE;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// All the stuff we need for playing and showing a video</span></span><br><span class="line">    <span class="keyword">private</span> IRenderView.ISurfaceHolder mSurfaceHolder = <span class="keyword">null</span>;</span><br><span class="line">    <span class="keyword">private</span> IMediaPlayer mMediaPlayer = <span class="keyword">null</span>;</span><br><span class="line">    <span class="comment">// private int         mAudioSession;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVideoWidth;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVideoHeight;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSurfaceWidth;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSurfaceHeight;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVideoRotationDegree;</span><br><span class="line">    <span class="keyword">private</span> IMediaController mMediaController;</span><br><span class="line">    <span class="keyword">private</span> IMediaPlayer.OnCompletionListener mOnCompletionListener;</span><br><span class="line">    <span class="keyword">private</span> IMediaPlayer.OnPreparedListener mOnPreparedListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mCurrentBufferPercentage;</span><br><span class="line">    <span class="keyword">private</span> IMediaPlayer.OnErrorListener mOnErrorListener;</span><br><span class="line">    <span class="keyword">private</span> IMediaPlayer.OnInfoListener mOnInfoListener;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mSeekWhenPrepared;  <span class="comment">// recording the seek position while preparing</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mCanPause = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mCanSeekBack = <span class="keyword">true</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">boolean</span> mCanSeekForward = <span class="keyword">true</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/** Subtitle rendering widget overlaid on top of the video. */</span></span><br><span class="line">    <span class="comment">// private RenderingWidget mSubtitleWidget;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Listener for changes to subtitle data, used to redraw when needed.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="comment">// private RenderingWidget.OnChangedListener mSubtitlesChangedListener;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> Context mAppContext;</span><br><span class="line">    <span class="keyword">private</span> Settings mSettings;</span><br><span class="line">    <span class="keyword">private</span> IRenderView mRenderView;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVideoSarNum;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> mVideoSarDen;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> InfoHudViewHolder mHudViewHolder;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mPrepareStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mPrepareEndTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mSeekStartTime = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">long</span> mSeekEndTime = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> TextView subtitleDisplay;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IjkVideoView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context);</span><br><span class="line">        initVideoView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IjkVideoView</span><span class="params">(Context context, AttributeSet attrs)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs);</span><br><span class="line">        initVideoView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IjkVideoView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        initVideoView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.LOLLIPOP)</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">IjkVideoView</span><span class="params">(Context context, AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr, defStyleRes);</span><br><span class="line">        initVideoView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// REMOVED: onMeasure</span></span><br><span class="line">    <span class="comment">// REMOVED: onInitializeAccessibilityEvent</span></span><br><span class="line">    <span class="comment">// REMOVED: onInitializeAccessibilityNodeInfo</span></span><br><span class="line">    <span class="comment">// REMOVED: resolveAdjustedSize</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initVideoView</span><span class="params">(Context context)</span> </span>&#123;</span><br><span class="line">        mAppContext = context.getApplicationContext();</span><br><span class="line">        mSettings = <span class="keyword">new</span> Settings(mAppContext);</span><br><span class="line"></span><br><span class="line">        initBackground();</span><br><span class="line">        initRenders();</span><br><span class="line"></span><br><span class="line">        mVideoWidth = <span class="number">0</span>;</span><br><span class="line">        mVideoHeight = <span class="number">0</span>;</span><br><span class="line">        <span class="comment">// REMOVED: getHolder().addCallback(mSHCallback);</span></span><br><span class="line">        <span class="comment">// REMOVED: getHolder().setType(SurfaceHolder.SURFACE_TYPE_PUSH_BUFFERS);</span></span><br><span class="line">        setFocusable(<span class="keyword">true</span>);</span><br><span class="line">        setFocusableInTouchMode(<span class="keyword">true</span>);</span><br><span class="line">        requestFocus();</span><br><span class="line">        <span class="comment">// REMOVED: mPendingSubtitleTracks = new Vector&lt;Pair&lt;InputStream, MediaFormat&gt;&gt;();</span></span><br><span class="line">        mCurrentState = STATE_IDLE;</span><br><span class="line">        mTargetState = STATE_IDLE;</span><br><span class="line"></span><br><span class="line">        subtitleDisplay = <span class="keyword">new</span> TextView(context);</span><br><span class="line">        subtitleDisplay.setTextSize(<span class="number">24</span>);</span><br><span class="line">        subtitleDisplay.setGravity(Gravity.CENTER);</span><br><span class="line">        FrameLayout.LayoutParams layoutParams_txt = <span class="keyword">new</span> FrameLayout.LayoutParams(</span><br><span class="line">                FrameLayout.LayoutParams.MATCH_PARENT,</span><br><span class="line">                FrameLayout.LayoutParams.WRAP_CONTENT,</span><br><span class="line">                Gravity.BOTTOM);</span><br><span class="line">        addView(subtitleDisplay, layoutParams_txt);</span><br><span class="line">    &#125;</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</span><br><span class="line">            mMediaPlayer.start();</span><br><span class="line">            mCurrentState = STATE_PLAYING;</span><br><span class="line">        &#125;</span><br><span class="line">        mTargetState = STATE_PLAYING;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (isInPlaybackState()) &#123;</span><br><span class="line">            <span class="keyword">if</span> (mMediaPlayer.isPlaying()) &#123;</span><br><span class="line">                mMediaPlayer.pause();</span><br><span class="line">                mCurrentState = STATE_PAUSED;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        mTargetState = STATE_PAUSED;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>IMediaPlayer.java<br><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">     * Do not change these values without updating their counterparts in native</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_UNKNOWN = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_STARTED_AS_NEXT = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_VIDEO_RENDERING_START = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_VIDEO_TRACK_LAGGING = <span class="number">700</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_BUFFERING_START = <span class="number">701</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_BUFFERING_END = <span class="number">702</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_NETWORK_BANDWIDTH = <span class="number">703</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_BAD_INTERLEAVING = <span class="number">800</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_NOT_SEEKABLE = <span class="number">801</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_METADATA_UPDATE = <span class="number">802</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_TIMED_TEXT_ERROR = <span class="number">900</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_UNSUPPORTED_SUBTITLE = <span class="number">901</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_SUBTITLE_TIMED_OUT = <span class="number">902</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_VIDEO_ROTATION_CHANGED = <span class="number">10001</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_AUDIO_RENDERING_START  = <span class="number">10002</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_AUDIO_DECODED_START    = <span class="number">10003</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_VIDEO_DECODED_START    = <span class="number">10004</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_OPEN_INPUT             = <span class="number">10005</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_FIND_STREAM_INFO       = <span class="number">10006</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_COMPONENT_OPEN         = <span class="number">10007</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_INFO_MEDIA_ACCURATE_SEEK_COMPLETE = <span class="number">10100</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_UNKNOWN = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_SERVER_DIED = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_NOT_VALID_FOR_PROGRESSIVE_PLAYBACK = <span class="number">200</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_IO = -<span class="number">1004</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_MALFORMED = -<span class="number">1007</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_UNSUPPORTED = -<span class="number">1010</span>;</span><br><span class="line">    <span class="keyword">int</span> MEDIA_ERROR_TIMED_OUT = -<span class="number">110</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDisplay</span><span class="params">(SurfaceHolder sh)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(Context context, Uri uri)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, IllegalArgumentException, SecurityException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@TargetApi</span>(Build.VERSION_CODES.ICE_CREAM_SANDWICH)</span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(Context context, Uri uri, Map&lt;String, String&gt; headers)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, IllegalArgumentException, SecurityException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(FileDescriptor fd)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, IllegalArgumentException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(String path)</span></span></span><br><span class="line"><span class="function">            <span class="keyword">throws</span> IOException, IllegalArgumentException, SecurityException, IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">String <span class="title">getDataSource</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">prepareAsync</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">stop</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">pause</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setScreenOnWhilePlaying</span><span class="params">(<span class="keyword">boolean</span> screenOn)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getVideoWidth</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getVideoHeight</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isPlaying</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">seekTo</span><span class="params">(<span class="keyword">long</span> msec)</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getCurrentPosition</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">long</span> <span class="title">getDuration</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">release</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">reset</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setVolume</span><span class="params">(<span class="keyword">float</span> leftVolume, <span class="keyword">float</span> rightVolume)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getAudioSessionId</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function">MediaInfo <span class="title">getMediaInfo</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"EmptyMethod"</span>)</span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setLogEnabled</span><span class="params">(<span class="keyword">boolean</span> enable)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isPlayable</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnPreparedListener</span><span class="params">(OnPreparedListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnCompletionListener</span><span class="params">(OnCompletionListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnBufferingUpdateListener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            OnBufferingUpdateListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnSeekCompleteListener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            OnSeekCompleteListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnVideoSizeChangedListener</span><span class="params">(</span></span></span><br><span class="line"><span class="function"><span class="params">            OnVideoSizeChangedListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnErrorListener</span><span class="params">(OnErrorListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnInfoListener</span><span class="params">(OnInfoListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setOnTimedTextListener</span><span class="params">(OnTimedTextListener listener)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*--------------------</span></span><br><span class="line"><span class="comment">     * Listeners</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnPreparedListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onPrepared</span><span class="params">(IMediaPlayer mp)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnCompletionListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onCompletion</span><span class="params">(IMediaPlayer mp)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnBufferingUpdateListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onBufferingUpdate</span><span class="params">(IMediaPlayer mp, <span class="keyword">int</span> percent)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnSeekCompleteListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onSeekComplete</span><span class="params">(IMediaPlayer mp)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnVideoSizeChangedListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onVideoSizeChanged</span><span class="params">(IMediaPlayer mp, <span class="keyword">int</span> width, <span class="keyword">int</span> height,</span></span></span><br><span class="line"><span class="function"><span class="params">                                <span class="keyword">int</span> sar_num, <span class="keyword">int</span> sar_den)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnErrorListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onError</span><span class="params">(IMediaPlayer mp, <span class="keyword">int</span> what, <span class="keyword">int</span> extra)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnInfoListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">boolean</span> <span class="title">onInfo</span><span class="params">(IMediaPlayer mp, <span class="keyword">int</span> what, <span class="keyword">int</span> extra)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">interface</span> <span class="title">OnTimedTextListener</span> </span>&#123;</span><br><span class="line">        <span class="function"><span class="keyword">void</span> <span class="title">onTimedText</span><span class="params">(IMediaPlayer mp, IjkTimedText text)</span></span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*--------------------</span></span><br><span class="line"><span class="comment">     * Optional</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setAudioStreamType</span><span class="params">(<span class="keyword">int</span> streamtype)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setKeepInBackground</span><span class="params">(<span class="keyword">boolean</span> keepInBackground)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getVideoSarNum</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">getVideoSarDen</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Deprecated</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setWakeMode</span><span class="params">(Context context, <span class="keyword">int</span> mode)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setLooping</span><span class="params">(<span class="keyword">boolean</span> looping)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">boolean</span> <span class="title">isLooping</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*--------------------</span></span><br><span class="line"><span class="comment">     * AndroidMediaPlayer: JELLY_BEAN</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    ITrackInfo[] getTrackInfo();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*--------------------</span></span><br><span class="line"><span class="comment">     * AndroidMediaPlayer: ICE_CREAM_SANDWICH:</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setSurface</span><span class="params">(Surface surface)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*--------------------</span></span><br><span class="line"><span class="comment">     * AndroidMediaPlayer: M:</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">setDataSource</span><span class="params">(IMediaDataSource mediaDataSource)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> bbcallen</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> *         Java wrapper of ffplay.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">IjkMediaPlayer</span> <span class="keyword">extends</span> <span class="title">AbstractMediaPlayer</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">static</span> String TAG = IjkMediaPlayer.class.getName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_NOP = <span class="number">0</span>; <span class="comment">// interface test message</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_PREPARED = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_PLAYBACK_COMPLETE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_BUFFERING_UPDATE = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_SEEK_COMPLETE = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_SET_VIDEO_SIZE = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_TIMED_TEXT = <span class="number">99</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_ERROR = <span class="number">100</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_INFO = <span class="number">200</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> MEDIA_SET_VIDEO_SAR = <span class="number">10001</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//----------------------------------------</span></span><br><span class="line">    <span class="comment">// options</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_UNKNOWN = <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_DEFAULT = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_VERBOSE = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_DEBUG = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_INFO = <span class="number">4</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_WARN = <span class="number">5</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_ERROR = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_FATAL = <span class="number">7</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> IJK_LOG_SILENT = <span class="number">8</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OPT_CATEGORY_FORMAT     = <span class="number">1</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OPT_CATEGORY_CODEC      = <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OPT_CATEGORY_SWS        = <span class="number">3</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> OPT_CATEGORY_PLAYER     = <span class="number">4</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SDL_FCC_YV12 = <span class="number">0x32315659</span>; <span class="comment">// YV12</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SDL_FCC_RV16 = <span class="number">0x36315652</span>; <span class="comment">// RGB565</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> SDL_FCC_RV32 = <span class="number">0x32335652</span>; <span class="comment">// RGBX8888</span></span><br><span class="line">    <span class="comment">//----------------------------------------</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException </span>&#123;</span><br><span class="line">        stayAwake(<span class="keyword">true</span>);</span><br><span class="line">        _start();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title">_start</span><span class="params">()</span> <span class="keyword">throws</span> IllegalStateException</span>;</span><br></pre></td></tr></table></figure>
<p>在ijkplayer-xxx 的jni ijkplayer_jni.c  文件中找到了定义映射的关系方法<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> JNINativeMethod g_methods[] = &#123;</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="string">"_setDataSource"</span>,</span><br><span class="line">        <span class="string">"(Ljava/lang/String;[Ljava/lang/String;[Ljava/lang/String;)V"</span>,</span><br><span class="line">        (<span class="keyword">void</span> *) IjkMediaPlayer_setDataSourceAndHeaders</span><br><span class="line">    &#125;,</span><br><span class="line">    &#123; <span class="string">"_setDataSourceFd"</span>,       <span class="string">"(I)V"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_setDataSourceFd &#125;,</span><br><span class="line">    &#123; <span class="string">"_setDataSource"</span>,         <span class="string">"(Ltv/danmaku/ijk/media/player/misc/IMediaDataSource;)V"</span>, (<span class="keyword">void</span> *)IjkMediaPlayer_setDataSourceCallback &#125;,</span><br><span class="line">    &#123; <span class="string">"_setAndroidIOCallback"</span>,  <span class="string">"(Ltv/danmaku/ijk/media/player/misc/IAndroidIO;)V"</span>, (<span class="keyword">void</span> *)IjkMediaPlayer_setAndroidIOCallback &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_setVideoSurface"</span>,       <span class="string">"(Landroid/view/Surface;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setVideoSurface &#125;,</span><br><span class="line">    &#123; <span class="string">"_prepareAsync"</span>,          <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_prepareAsync &#125;,</span><br><span class="line">    &#123; <span class="string">"_start"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_start &#125;,</span><br><span class="line">    &#123; <span class="string">"_stop"</span>,                  <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_stop &#125;,</span><br><span class="line">    &#123; <span class="string">"seekTo"</span>,                 <span class="string">"(J)V"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_seekTo &#125;,</span><br><span class="line">    &#123; <span class="string">"_pause"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_pause &#125;,</span><br><span class="line">    &#123; <span class="string">"isPlaying"</span>,              <span class="string">"()Z"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_isPlaying &#125;,</span><br><span class="line">    &#123; <span class="string">"getCurrentPosition"</span>,     <span class="string">"()J"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getCurrentPosition &#125;,</span><br><span class="line">    &#123; <span class="string">"getDuration"</span>,            <span class="string">"()J"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getDuration &#125;,</span><br><span class="line">    &#123; <span class="string">"_release"</span>,               <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_release &#125;,</span><br><span class="line">    &#123; <span class="string">"_reset"</span>,                 <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_reset &#125;,</span><br><span class="line">    &#123; <span class="string">"setVolume"</span>,              <span class="string">"(FF)V"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_setVolume &#125;,</span><br><span class="line">    &#123; <span class="string">"getAudioSessionId"</span>,      <span class="string">"()I"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_getAudioSessionId &#125;,</span><br><span class="line">    &#123; <span class="string">"native_init"</span>,            <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_native_init &#125;,</span><br><span class="line">    &#123; <span class="string">"native_setup"</span>,           <span class="string">"(Ljava/lang/Object;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_native_setup &#125;,</span><br><span class="line">    &#123; <span class="string">"native_finalize"</span>,        <span class="string">"()V"</span>,      (<span class="keyword">void</span> *) IjkMediaPlayer_native_finalize &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_setOption"</span>,             <span class="string">"(ILjava/lang/String;Ljava/lang/String;)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setOption &#125;,</span><br><span class="line">    &#123; <span class="string">"_setOption"</span>,             <span class="string">"(ILjava/lang/String;J)V"</span>,                  (<span class="keyword">void</span> *) IjkMediaPlayer_setOptionLong &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"_getColorFormatName"</span>,    <span class="string">"(I)Ljava/lang/String;"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_getColorFormatName &#125;,</span><br><span class="line">    &#123; <span class="string">"_getVideoCodecInfo"</span>,     <span class="string">"()Ljava/lang/String;"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_getVideoCodecInfo &#125;,</span><br><span class="line">    &#123; <span class="string">"_getAudioCodecInfo"</span>,     <span class="string">"()Ljava/lang/String;"</span>,     (<span class="keyword">void</span> *) IjkMediaPlayer_getAudioCodecInfo &#125;,</span><br><span class="line">    &#123; <span class="string">"_getMediaMeta"</span>,          <span class="string">"()Landroid/os/Bundle;"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_getMediaMeta &#125;,</span><br><span class="line">    &#123; <span class="string">"_setLoopCount"</span>,          <span class="string">"(I)V"</span>,                     (<span class="keyword">void</span> *) IjkMediaPlayer_setLoopCount &#125;,</span><br><span class="line">    &#123; <span class="string">"_getLoopCount"</span>,          <span class="string">"()I"</span>,                      (<span class="keyword">void</span> *) IjkMediaPlayer_getLoopCount &#125;,</span><br><span class="line">    &#123; <span class="string">"_getPropertyFloat"</span>,      <span class="string">"(IF)F"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_getPropertyFloat &#125;,</span><br><span class="line">    &#123; <span class="string">"_setPropertyFloat"</span>,      <span class="string">"(IF)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setPropertyFloat &#125;,</span><br><span class="line">    &#123; <span class="string">"_getPropertyLong"</span>,       <span class="string">"(IJ)J"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_getPropertyLong &#125;,</span><br><span class="line">    &#123; <span class="string">"_setPropertyLong"</span>,       <span class="string">"(IJ)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setPropertyLong &#125;,</span><br><span class="line">    &#123; <span class="string">"_setStreamSelected"</span>,     <span class="string">"(IZ)V"</span>,                    (<span class="keyword">void</span> *) ijkMediaPlayer_setStreamSelected &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"native_profileBegin"</span>,    <span class="string">"(Ljava/lang/String;)V"</span>,    (<span class="keyword">void</span> *) IjkMediaPlayer_native_profileBegin &#125;,</span><br><span class="line">    &#123; <span class="string">"native_profileEnd"</span>,      <span class="string">"()V"</span>,                      (<span class="keyword">void</span> *) IjkMediaPlayer_native_profileEnd &#125;,</span><br><span class="line"></span><br><span class="line">    &#123; <span class="string">"native_setLogLevel"</span>,     <span class="string">"(I)V"</span>,                     (<span class="keyword">void</span> *) IjkMediaPlayer_native_setLogLevel &#125;,</span><br><span class="line">    &#123; <span class="string">"_setFrameAtTime"</span>,        <span class="string">"(Ljava/lang/String;JJII)V"</span>, (<span class="keyword">void</span> *) IjkMediaPlayer_setFrameAtTime &#125;,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_start(JNIEnv *env, jobject thiz)</span><br><span class="line">&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: start: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    ijkmp_start(mp);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_stop(JNIEnv *env, jobject thiz)</span><br><span class="line">&#123;</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: stop: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    ijkmp_stop(mp);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_pause(JNIEnv *env, jobject thiz)</span><br><span class="line">&#123;</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: pause: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    ijkmp_pause(mp);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">IjkMediaPlayer_seekTo(JNIEnv *env, jobject thiz, jlong msec)</span><br><span class="line">&#123;</span><br><span class="line">    MPTRACE(<span class="string">"%s\n"</span>, __func__);</span><br><span class="line">    IjkMediaPlayer *mp = jni_get_media_player(env, thiz);</span><br><span class="line">    JNI_CHECK_GOTO(mp, env, <span class="string">"java/lang/IllegalStateException"</span>, <span class="string">"mpjni: seekTo: null mp"</span>, LABEL_RETURN);</span><br><span class="line"></span><br><span class="line">    ijkmp_seek_to(mp, msec);</span><br><span class="line"></span><br><span class="line">LABEL_RETURN:</span><br><span class="line">    ijkmp_dec_ref_p(&amp;mp);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>ffplay 如何返回给java层消息处理呢，ijkplayer代码说明了一切</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">EventHandler</span> <span class="keyword">extends</span> <span class="title">Handler</span> </span>&#123;</span><br><span class="line">       <span class="keyword">private</span> <span class="keyword">final</span> WeakReference&lt;IjkMediaPlayer&gt; mWeakPlayer;</span><br><span class="line"></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="title">EventHandler</span><span class="params">(IjkMediaPlayer mp, Looper looper)</span> </span>&#123;</span><br><span class="line">           <span class="keyword">super</span>(looper);</span><br><span class="line">           mWeakPlayer = <span class="keyword">new</span> WeakReference&lt;IjkMediaPlayer&gt;(mp);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="meta">@Override</span></span><br><span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">handleMessage</span><span class="params">(Message msg)</span> </span>&#123;</span><br><span class="line">           IjkMediaPlayer player = mWeakPlayer.get();</span><br><span class="line">           <span class="keyword">if</span> (player == <span class="keyword">null</span> || player.mNativeMediaPlayer == <span class="number">0</span>) &#123;</span><br><span class="line">               DebugLog.w(TAG,</span><br><span class="line">                       <span class="string">"IjkMediaPlayer went away with unhandled events"</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">switch</span> (msg.what) &#123;</span><br><span class="line">           <span class="keyword">case</span> MEDIA_PREPARED:</span><br><span class="line">               player.notifyOnPrepared();</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_PLAYBACK_COMPLETE:</span><br><span class="line">               player.stayAwake(<span class="keyword">false</span>);</span><br><span class="line">               player.notifyOnCompletion();</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_BUFFERING_UPDATE:</span><br><span class="line">               <span class="keyword">long</span> bufferPosition = msg.arg1;</span><br><span class="line">               <span class="keyword">if</span> (bufferPosition &lt; <span class="number">0</span>) &#123;</span><br><span class="line">                   bufferPosition = <span class="number">0</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">long</span> percent = <span class="number">0</span>;</span><br><span class="line">               <span class="keyword">long</span> duration = player.getDuration();</span><br><span class="line">               <span class="keyword">if</span> (duration &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                   percent = bufferPosition * <span class="number">100</span> / duration;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (percent &gt;= <span class="number">100</span>) &#123;</span><br><span class="line">                   percent = <span class="number">100</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="comment">// DebugLog.efmt(TAG, "Buffer (%d%%) %d/%d",  percent, bufferPosition, duration);</span></span><br><span class="line">               player.notifyOnBufferingUpdate((<span class="keyword">int</span>)percent);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_SEEK_COMPLETE:</span><br><span class="line">               player.notifyOnSeekComplete();</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_SET_VIDEO_SIZE:</span><br><span class="line">               player.mVideoWidth = msg.arg1;</span><br><span class="line">               player.mVideoHeight = msg.arg2;</span><br><span class="line">               player.notifyOnVideoSizeChanged(player.mVideoWidth, player.mVideoHeight,</span><br><span class="line">                       player.mVideoSarNum, player.mVideoSarDen);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_ERROR:</span><br><span class="line">               DebugLog.e(TAG, <span class="string">"Error ("</span> + msg.arg1 + <span class="string">","</span> + msg.arg2 + <span class="string">")"</span>);</span><br><span class="line">               <span class="keyword">if</span> (!player.notifyOnError(msg.arg1, msg.arg2)) &#123;</span><br><span class="line">                   player.notifyOnCompletion();</span><br><span class="line">               &#125;</span><br><span class="line">               player.stayAwake(<span class="keyword">false</span>);</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_INFO:</span><br><span class="line">               <span class="keyword">switch</span> (msg.arg1) &#123;</span><br><span class="line">                   <span class="keyword">case</span> MEDIA_INFO_VIDEO_RENDERING_START:</span><br><span class="line">                       DebugLog.i(TAG, <span class="string">"Info: MEDIA_INFO_VIDEO_RENDERING_START\n"</span>);</span><br><span class="line">                       <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               player.notifyOnInfo(msg.arg1, msg.arg2);</span><br><span class="line">               <span class="comment">// No real default action so far.</span></span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           <span class="keyword">case</span> MEDIA_TIMED_TEXT:</span><br><span class="line">               <span class="keyword">if</span> (msg.obj == <span class="keyword">null</span>) &#123;</span><br><span class="line">                   player.notifyOnTimedText(<span class="keyword">null</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                   IjkTimedText text = <span class="keyword">new</span> IjkTimedText(<span class="keyword">new</span> Rect(<span class="number">0</span>, <span class="number">0</span>, <span class="number">1</span>, <span class="number">1</span>), (String)msg.obj);</span><br><span class="line">                   player.notifyOnTimedText(text);</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span>;</span><br><span class="line">           <span class="keyword">case</span> MEDIA_NOP: <span class="comment">// interface test message - ignore</span></span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">case</span> MEDIA_SET_VIDEO_SAR:</span><br><span class="line">               player.mVideoSarNum = msg.arg1;</span><br><span class="line">               player.mVideoSarDen = msg.arg2;</span><br><span class="line">               player.notifyOnVideoSizeChanged(player.mVideoWidth, player.mVideoHeight,</span><br><span class="line">                       player.mVideoSarNum, player.mVideoSarDen);</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">           <span class="keyword">default</span>:</span><br><span class="line">               DebugLog.e(TAG, <span class="string">"Unknown message type "</span> + msg.what);</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>如下图：</p>
<p><img src="http://o8ra1yomr.bkt.clouddn.com/屏幕快照%202018-01-12%20下午5.42.39.png" width="400"></p>
<h2 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h2><p>通过上面的代码 分析播放器的start（），pause（）方法，可以看出这个调用流程为<br>java 层 ijkVideoView start()–&gt;IMediaPlayer start()–&gt;ijkMediaPlayer start()<br>jni 层 –&gt;start()–&gt;ffplay 内部处理–&gt; 返回java层消息处理</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>ijkplayer主要由Java层和JNI层组成，Java层主要负责业务控制，JNI部分主要功能是完成音视频的播放。JNI层向Java层提供接口调用，形成事件任务，同时以回调的形式向Java层推送事件完成的状态通知。</p>
<p>ijkplayer-exo和ijkplayer-java两个类库，分别代表两个不同的播放器。 ijkplayer-exo支持webm格式视频，看项目需求是否添加。</p>
<p>ijkplayer-java的底层JNI基于ffplay。ijkplayer通过实现了消息队列进行了消息的处理工作。</p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p><a href="https://github.com/Bilibili/ijkplayer" target="_blank" rel="noopener">ijkplayer github地址</a></p>
<!--more-->

      
    </div>
    <footer class="article-footer">
      <a data-url="http://yoursite.com/2018/01/14/Ijkplayer-android端执行流程分析/" data-id="ckh22rgy6000mbz3kkxzlxzph" class="article-share-link">Delen</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/media/">media</a></li></ul>

    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2020/10/28/搜索项目apk文件/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Nieuwer</strong>
      <div class="article-nav-title">
        
          搜索项目apk文件
        
      </div>
    </a>
  
  
    <a href="/2018/01/14/android-播放器调研分析/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ouder</strong>
      <div class="article-nav-title">android 播放器调研分析</div>
    </a>
  
</nav>

  
</article>

</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categorieën</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Algorithm/">Algorithm</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Android/">Android</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Config/">Config</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/CustomView/">CustomView</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Data-Structure/">Data Structure</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Design-Pattern/">Design Pattern</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Java/">Java</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/media/">media</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Labels</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activity/">Activity</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Activity-View/">Activity View</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Glide/">Glide</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ImageView/">ImageView</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Java/">Java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Jni/">Jni</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Ndk/">Ndk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ProGuard/">ProGuard</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Retrofit/">Retrofit</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ScaleType/">ScaleType</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/clock/">clock</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/java/">java</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/jenkins/">jenkins</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/maven/">maven</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/media/">media</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/permission/">permission</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/viewgroup/">viewgroup</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/组件化/">组件化</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Activity/" style="font-size: 13.33px;">Activity</a> <a href="/tags/Activity-View/" style="font-size: 10px;">Activity View</a> <a href="/tags/Glide/" style="font-size: 10px;">Glide</a> <a href="/tags/ImageView/" style="font-size: 10px;">ImageView</a> <a href="/tags/Java/" style="font-size: 20px;">Java</a> <a href="/tags/Jni/" style="font-size: 10px;">Jni</a> <a href="/tags/Ndk/" style="font-size: 10px;">Ndk</a> <a href="/tags/ProGuard/" style="font-size: 10px;">ProGuard</a> <a href="/tags/Retrofit/" style="font-size: 16.67px;">Retrofit</a> <a href="/tags/ScaleType/" style="font-size: 10px;">ScaleType</a> <a href="/tags/clock/" style="font-size: 13.33px;">clock</a> <a href="/tags/java/" style="font-size: 10px;">java</a> <a href="/tags/jenkins/" style="font-size: 13.33px;">jenkins</a> <a href="/tags/maven/" style="font-size: 10px;">maven</a> <a href="/tags/media/" style="font-size: 13.33px;">media</a> <a href="/tags/permission/" style="font-size: 10px;">permission</a> <a href="/tags/viewgroup/" style="font-size: 10px;">viewgroup</a> <a href="/tags/组件化/" style="font-size: 10px;">组件化</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archieven</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/11/">November 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2020/10/">October 2020</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">January 2018</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/12/">December 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">November 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">August 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/07/">July 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/04/">April 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/03/">March 2017</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/12/">December 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/08/">August 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/06/">June 2016</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recente berichten</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2020/11/03/项目解耦之context获取/">项目解耦之context获取</a>
          </li>
        
          <li>
            <a href="/2020/10/29/Activity如何计算view的层级深度/">Activity如何计算view的层级深度</a>
          </li>
        
          <li>
            <a href="/2020/10/28/搜索项目apk文件/">搜索项目apk文件</a>
          </li>
        
          <li>
            <a href="/2018/01/14/Ijkplayer-android端执行流程分析/">Ijkplayer android端执行流程分析</a>
          </li>
        
          <li>
            <a href="/2018/01/14/android-播放器调研分析/">android 播放器调研分析</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2020 bei1999<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>